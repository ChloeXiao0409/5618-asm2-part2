<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Wand.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">core</a> &gt; <a href="index.source.html" class="el_package">com.shatteredpixel.shatteredpixeldungeon.items.wands</a> &gt; <span class="el_source">Wand.java</span></div><h1>Wand.java</h1><pre class="source lang-java linenums">/*
 * Pixel Dungeon
 * Copyright (C) 2012-2015 Oleg Dolya
 *
 * Shattered Pixel Dungeon
 * Copyright (C) 2014-2024 Evan Debenham
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;
 */

package com.shatteredpixel.shatteredpixeldungeon.items.wands;

import com.shatteredpixel.shatteredpixeldungeon.Assets;
import com.shatteredpixel.shatteredpixeldungeon.Badges;
import com.shatteredpixel.shatteredpixeldungeon.Dungeon;
import com.shatteredpixel.shatteredpixeldungeon.actors.Actor;
import com.shatteredpixel.shatteredpixeldungeon.actors.Char;
import com.shatteredpixel.shatteredpixeldungeon.actors.buffs.Barrier;
import com.shatteredpixel.shatteredpixeldungeon.actors.buffs.Blindness;
import com.shatteredpixel.shatteredpixeldungeon.actors.buffs.Buff;
import com.shatteredpixel.shatteredpixeldungeon.actors.buffs.Degrade;
import com.shatteredpixel.shatteredpixeldungeon.actors.buffs.Invisibility;
import com.shatteredpixel.shatteredpixeldungeon.actors.buffs.MagicImmune;
import com.shatteredpixel.shatteredpixeldungeon.actors.buffs.Recharging;
import com.shatteredpixel.shatteredpixeldungeon.actors.buffs.Regeneration;
import com.shatteredpixel.shatteredpixeldungeon.actors.buffs.ScrollEmpower;
import com.shatteredpixel.shatteredpixeldungeon.actors.buffs.SoulMark;
import com.shatteredpixel.shatteredpixeldungeon.actors.hero.Hero;
import com.shatteredpixel.shatteredpixeldungeon.actors.hero.HeroClass;
import com.shatteredpixel.shatteredpixeldungeon.actors.hero.HeroSubClass;
import com.shatteredpixel.shatteredpixeldungeon.actors.hero.Talent;
import com.shatteredpixel.shatteredpixeldungeon.actors.hero.abilities.mage.WildMagic;
import com.shatteredpixel.shatteredpixeldungeon.actors.hero.spells.DivineSense;
import com.shatteredpixel.shatteredpixeldungeon.actors.hero.spells.GuidingLight;
import com.shatteredpixel.shatteredpixeldungeon.effects.Flare;
import com.shatteredpixel.shatteredpixeldungeon.effects.FloatingText;
import com.shatteredpixel.shatteredpixeldungeon.effects.MagicMissile;
import com.shatteredpixel.shatteredpixeldungeon.items.Item;
import com.shatteredpixel.shatteredpixeldungeon.items.artifacts.TalismanOfForesight;
import com.shatteredpixel.shatteredpixeldungeon.items.bags.Bag;
import com.shatteredpixel.shatteredpixeldungeon.items.bags.MagicalHolster;
import com.shatteredpixel.shatteredpixeldungeon.items.rings.RingOfEnergy;
import com.shatteredpixel.shatteredpixeldungeon.items.scrolls.ScrollOfRecharging;
import com.shatteredpixel.shatteredpixeldungeon.items.trinkets.ShardOfOblivion;
import com.shatteredpixel.shatteredpixeldungeon.items.trinkets.WondrousResin;
import com.shatteredpixel.shatteredpixeldungeon.items.weapon.melee.MagesStaff;
import com.shatteredpixel.shatteredpixeldungeon.mechanics.Ballistica;
import com.shatteredpixel.shatteredpixeldungeon.messages.Messages;
import com.shatteredpixel.shatteredpixeldungeon.scenes.CellSelector;
import com.shatteredpixel.shatteredpixeldungeon.scenes.GameScene;
import com.shatteredpixel.shatteredpixeldungeon.sprites.CharSprite;
import com.shatteredpixel.shatteredpixeldungeon.sprites.ItemSprite;
import com.shatteredpixel.shatteredpixeldungeon.sprites.ItemSpriteSheet;
import com.shatteredpixel.shatteredpixeldungeon.ui.QuickSlotButton;
import com.shatteredpixel.shatteredpixeldungeon.utils.GLog;
import com.watabou.noosa.audio.Sample;
import com.watabou.utils.Bundle;
import com.watabou.utils.Callback;
import com.watabou.utils.PointF;
import com.watabou.utils.Random;

import java.util.ArrayList;

<span class="nc" id="L75">public abstract class Wand extends Item {</span>

	public static final String AC_ZAP	= &quot;ZAP&quot;;

	private static final float TIME_TO_ZAP	= 1f;
	
<span class="nc" id="L81">	public int maxCharges = initialCharges();</span>
<span class="nc" id="L82">	public int curCharges = maxCharges;</span>
<span class="nc" id="L83">	public float partialCharge = 0f;</span>
	
	protected Charger charger;
	
<span class="nc" id="L87">	public boolean curChargeKnown = false;</span>
	
<span class="nc" id="L89">	public boolean curseInfusionBonus = false;</span>
<span class="nc" id="L90">	public int resinBonus = 0;</span>

	private static final int USES_TO_ID = 10;
<span class="nc" id="L93">	private float usesLeftToID = USES_TO_ID;</span>
<span class="nc" id="L94">	private float availableUsesToID = USES_TO_ID/2f;</span>

<span class="nc" id="L96">	protected int collisionProperties = Ballistica.MAGIC_BOLT;</span>
	
	{
<span class="nc" id="L99">		defaultAction = AC_ZAP;</span>
<span class="nc" id="L100">		usesTargeting = true;</span>
<span class="nc" id="L101">		bones = true;</span>
<span class="nc" id="L102">	}</span>
	
	@Override
	public ArrayList&lt;String&gt; actions( Hero hero ) {
<span class="nc" id="L106">		ArrayList&lt;String&gt; actions = super.actions( hero );</span>
<span class="nc bnc" id="L107" title="All 4 branches missed.">		if (curCharges &gt; 0 || !curChargeKnown) {</span>
<span class="nc" id="L108">			actions.add( AC_ZAP );</span>
		}

<span class="nc" id="L111">		return actions;</span>
	}
	
	@Override
	public void execute( Hero hero, String action ) {

<span class="nc" id="L117">		super.execute( hero, action );</span>

<span class="nc bnc" id="L119" title="All 2 branches missed.">		if (action.equals( AC_ZAP )) {</span>
			
<span class="nc" id="L121">			curUser = hero;</span>
<span class="nc" id="L122">			curItem = this;</span>
<span class="nc" id="L123">			GameScene.selectCell( zapper );</span>
			
		}
<span class="nc" id="L126">	}</span>

	@Override
	public int targetingPos(Hero user, int dst) {
<span class="nc bnc" id="L130" title="All 4 branches missed.">		if (cursed &amp;&amp; cursedKnown){</span>
<span class="nc" id="L131">			return new Ballistica(user.pos, dst, Ballistica.MAGIC_BOLT).collisionPos;</span>
		} else {
<span class="nc" id="L133">			return new Ballistica(user.pos, dst, collisionProperties).collisionPos;</span>
		}
	}

	public abstract void onZap(Ballistica attack);

	public abstract void onHit( MagesStaff staff, Char attacker, Char defender, int damage);

	//not affected by enchantment proc chance changers
	public static float procChanceMultiplier( Char attacker ){
<span class="nc bnc" id="L143" title="All 2 branches missed.">		if (attacker.buff(Talent.EmpoweredStrikeTracker.class) != null){</span>
<span class="nc" id="L144">			return 1f + ((Hero)attacker).pointsInTalent(Talent.EMPOWERED_STRIKE)/2f;</span>
		}
<span class="nc" id="L146">		return 1f;</span>
	}

	public boolean tryToZap( Hero owner, int target ){

<span class="nc bnc" id="L151" title="All 4 branches missed.">		if (owner.buff(WildMagic.WildMagicTracker.class) == null &amp;&amp; owner.buff(MagicImmune.class) != null){</span>
<span class="nc" id="L152">			GLog.w( Messages.get(this, &quot;no_magic&quot;) );</span>
<span class="nc" id="L153">			return false;</span>
		}

		//if we're using wild magic, then assume we have charges
<span class="nc bnc" id="L157" title="All 4 branches missed.">		if ( owner.buff(WildMagic.WildMagicTracker.class) != null || curCharges &gt;= chargesPerCast()){</span>
<span class="nc" id="L158">			return true;</span>
		} else {
<span class="nc" id="L160">			GLog.w(Messages.get(this, &quot;fizzles&quot;));</span>
<span class="nc" id="L161">			return false;</span>
		}
	}

	@Override
	public boolean collect( Bag container ) {
<span class="nc bnc" id="L167" title="All 2 branches missed.">		if (super.collect( container )) {</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">			if (container.owner != null) {</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">				if (container instanceof MagicalHolster)</span>
<span class="nc" id="L170">					charge( container.owner, ((MagicalHolster) container).HOLSTER_SCALE_FACTOR );</span>
				else
<span class="nc" id="L172">					charge( container.owner );</span>
			}
<span class="nc" id="L174">			return true;</span>
		} else {
<span class="nc" id="L176">			return false;</span>
		}
	}

	public void gainCharge( float amt ){
<span class="nc" id="L181">		gainCharge( amt, false );</span>
<span class="nc" id="L182">	}</span>

	public void gainCharge( float amt, boolean overcharge ){
<span class="nc" id="L185">		partialCharge += amt;</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">		while (partialCharge &gt;= 1) {</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">			if (overcharge) curCharges = Math.min(maxCharges+(int)amt, curCharges+1);</span>
<span class="nc" id="L188">			else curCharges = Math.min(maxCharges, curCharges+1);</span>
<span class="nc" id="L189">			partialCharge--;</span>
<span class="nc" id="L190">			updateQuickslot();</span>
		}
<span class="nc" id="L192">	}</span>
	
	public void charge( Char owner ) {
<span class="nc bnc" id="L195" title="All 2 branches missed.">		if (charger == null) charger = new Charger();</span>
<span class="nc" id="L196">		charger.attachTo( owner );</span>
<span class="nc" id="L197">	}</span>

	public void charge( Char owner, float chargeScaleFactor ){
<span class="nc" id="L200">		charge( owner );</span>
<span class="nc" id="L201">		charger.setScaleFactor( chargeScaleFactor );</span>
<span class="nc" id="L202">	}</span>

	protected void wandProc(Char target, int chargesUsed){
<span class="nc" id="L205">		wandProc(target, buffedLvl(), chargesUsed);</span>
<span class="nc" id="L206">	}</span>

	//TODO Consider externalizing char awareness buff
	protected static void wandProc(Char target, int wandLevel, int chargesUsed){
<span class="nc bnc" id="L210" title="All 2 branches missed.">		if (Dungeon.hero.hasTalent(Talent.ARCANE_VISION)) {</span>
<span class="nc" id="L211">			int dur = 5 + 5*Dungeon.hero.pointsInTalent(Talent.ARCANE_VISION);</span>
<span class="nc" id="L212">			Buff.append(Dungeon.hero, TalismanOfForesight.CharAwareness.class, dur).charID = target.id();</span>
		}

<span class="nc bnc" id="L215" title="All 4 branches missed.">		if (target != Dungeon.hero &amp;&amp;</span>
				Dungeon.hero.subClass == HeroSubClass.WARLOCK &amp;&amp;
				//standard 1 - 0.92^x chance, plus 7%. Starts at 15%
<span class="nc bnc" id="L218" title="All 2 branches missed.">				Random.Float() &gt; (Math.pow(0.92f, (wandLevel*chargesUsed)+1) - 0.07f)){</span>
<span class="nc" id="L219">			SoulMark.prolong(target, SoulMark.class, SoulMark.DURATION + wandLevel);</span>
		}

<span class="nc bnc" id="L222" title="All 4 branches missed.">		if (Dungeon.hero.subClass == HeroSubClass.PRIEST &amp;&amp; target.buff(GuidingLight.Illuminated.class) != null) {</span>
<span class="nc" id="L223">			target.buff(GuidingLight.Illuminated.class).detach();</span>
<span class="nc" id="L224">			target.damage(Dungeon.hero.lvl, GuidingLight.INSTANCE);</span>
		}

<span class="nc bnc" id="L227" title="All 4 branches missed.">		if (target.alignment != Char.Alignment.ALLY</span>
				&amp;&amp; Dungeon.hero.heroClass != HeroClass.CLERIC
<span class="nc bnc" id="L229" title="All 2 branches missed.">				&amp;&amp; Dungeon.hero.hasTalent(Talent.SEARING_LIGHT)</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">				&amp;&amp; Dungeon.hero.buff(Talent.SearingLightCooldown.class) == null){</span>
<span class="nc" id="L231">			Buff.affect(target, GuidingLight.Illuminated.class);</span>
<span class="nc" id="L232">			Buff.affect(Dungeon.hero, Talent.SearingLightCooldown.class, 20f);</span>
		}

<span class="nc bnc" id="L235" title="All 4 branches missed.">		if (target.alignment != Char.Alignment.ALLY</span>
				&amp;&amp; Dungeon.hero.heroClass != HeroClass.CLERIC
<span class="nc bnc" id="L237" title="All 2 branches missed.">				&amp;&amp; Dungeon.hero.hasTalent(Talent.SUNRAY)){</span>
			// 15/25% chance
<span class="nc bnc" id="L239" title="All 2 branches missed.">			if (Random.Int(20) &lt; 1 + 2*Dungeon.hero.pointsInTalent(Talent.SUNRAY)){</span>
<span class="nc" id="L240">				Buff.prolong(target, Blindness.class, 4f);</span>
			}
		}
<span class="nc" id="L243">	}</span>

	@Override
	public void onDetach( ) {
<span class="nc" id="L247">		stopCharging();</span>
<span class="nc" id="L248">	}</span>

	public void stopCharging() {
<span class="nc bnc" id="L251" title="All 2 branches missed.">		if (charger != null) {</span>
<span class="nc" id="L252">			charger.detach();</span>
<span class="nc" id="L253">			charger = null;</span>
		}
<span class="nc" id="L255">	}</span>
	
	public void level( int value) {
<span class="nc" id="L258">		super.level( value );</span>
<span class="nc" id="L259">		updateLevel();</span>
<span class="nc" id="L260">	}</span>
	
	@Override
	public Item identify( boolean byHero ) {
		
<span class="nc" id="L265">		curChargeKnown = true;</span>
<span class="nc" id="L266">		super.identify(byHero);</span>
		
<span class="nc" id="L268">		updateQuickslot();</span>
		
<span class="nc" id="L270">		return this;</span>
	}

	public void setIDReady(){
<span class="nc" id="L274">		usesLeftToID = -1;</span>
<span class="nc" id="L275">	}</span>

	public boolean readyToIdentify(){
<span class="nc bnc" id="L278" title="All 4 branches missed.">		return !isIdentified() &amp;&amp; usesLeftToID &lt;= 0;</span>
	}
	
	public void onHeroGainExp( float levelPercent, Hero hero ){
<span class="nc" id="L282">		levelPercent *= Talent.itemIDSpeedFactor(hero, this);</span>
<span class="nc bnc" id="L283" title="All 4 branches missed.">		if (!isIdentified() &amp;&amp; availableUsesToID &lt;= USES_TO_ID/2f) {</span>
			//gains enough uses to ID over 1 level
<span class="nc" id="L285">			availableUsesToID = Math.min(USES_TO_ID/2f, availableUsesToID + levelPercent * USES_TO_ID/2f);</span>
		}
<span class="nc" id="L287">	}</span>

	@Override
	public String info() {
<span class="nc" id="L291">		String desc = super.info();</span>

<span class="nc" id="L293">		desc += &quot;\n\n&quot; + statsDesc();</span>

<span class="nc bnc" id="L295" title="All 2 branches missed.">		if (resinBonus == 1){</span>
<span class="nc" id="L296">			desc += &quot;\n\n&quot; + Messages.get(Wand.class, &quot;resin_one&quot;);</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">		} else if (resinBonus &gt; 1){</span>
<span class="nc" id="L298">			desc += &quot;\n\n&quot; + Messages.get(Wand.class, &quot;resin_many&quot;, resinBonus);</span>
		}

<span class="nc bnc" id="L301" title="All 4 branches missed.">		if (cursed &amp;&amp; cursedKnown) {</span>
<span class="nc" id="L302">			desc += &quot;\n\n&quot; + Messages.get(Wand.class, &quot;cursed&quot;);</span>
<span class="nc bnc" id="L303" title="All 4 branches missed.">		} else if (!isIdentified() &amp;&amp; cursedKnown){</span>
<span class="nc" id="L304">			desc += &quot;\n\n&quot; + Messages.get(Wand.class, &quot;not_cursed&quot;);</span>
		}

<span class="nc bnc" id="L307" title="All 4 branches missed.">		if (Dungeon.hero != null &amp;&amp; Dungeon.hero.subClass == HeroSubClass.BATTLEMAGE){</span>
<span class="nc" id="L308">			desc += &quot;\n\n&quot; + Messages.get(this, &quot;bmage_desc&quot;);</span>
		}

<span class="nc" id="L311">		return desc;</span>
	}

	public String statsDesc(){
<span class="nc" id="L315">		return Messages.get(this, &quot;stats_desc&quot;);</span>
	}

	public String upgradeStat1(int level){
<span class="nc" id="L319">		return null;</span>
	}

	public String upgradeStat2(int level){
<span class="nc" id="L323">		return null;</span>
	}

	public String upgradeStat3(int level){
<span class="nc" id="L327">		return null;</span>
	}
	
	@Override
	public boolean isIdentified() {
<span class="nc bnc" id="L332" title="All 4 branches missed.">		return super.isIdentified() &amp;&amp; curChargeKnown;</span>
	}
	
	@Override
	public String status() {
<span class="nc bnc" id="L337" title="All 2 branches missed.">		if (levelKnown) {</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">			return (curChargeKnown ? curCharges : &quot;?&quot;) + &quot;/&quot; + maxCharges;</span>
		} else {
<span class="nc" id="L340">			return null;</span>
		}
	}
	
	@Override
	public int level() {
<span class="nc bnc" id="L346" title="All 4 branches missed.">		if (!cursed &amp;&amp; curseInfusionBonus){</span>
<span class="nc" id="L347">			curseInfusionBonus = false;</span>
<span class="nc" id="L348">			updateLevel();</span>
		}
<span class="nc" id="L350">		int level = super.level();</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">		if (curseInfusionBonus) level += 1 + level/6;</span>
<span class="nc" id="L352">		level += resinBonus;</span>
<span class="nc" id="L353">		return level;</span>
	}
	
	@Override
	public Item upgrade() {

<span class="nc" id="L359">		super.upgrade();</span>

<span class="nc bnc" id="L361" title="All 2 branches missed.">		if (Random.Int(3) == 0) {</span>
<span class="nc" id="L362">			cursed = false;</span>
		}

<span class="nc bnc" id="L365" title="All 2 branches missed.">		if (resinBonus &gt; 0){</span>
<span class="nc" id="L366">			resinBonus--;</span>
		}

<span class="nc" id="L369">		updateLevel();</span>
<span class="nc" id="L370">		curCharges = Math.min( curCharges + 1, maxCharges );</span>
<span class="nc" id="L371">		updateQuickslot();</span>
		
<span class="nc" id="L373">		return this;</span>
	}
	
	@Override
	public Item degrade() {
<span class="nc" id="L378">		super.degrade();</span>
		
<span class="nc" id="L380">		updateLevel();</span>
<span class="nc" id="L381">		updateQuickslot();</span>
		
<span class="nc" id="L383">		return this;</span>
	}

	@Override
	public int buffedLvl() {
<span class="nc" id="L388">		int lvl = super.buffedLvl();</span>

<span class="nc bnc" id="L390" title="All 4 branches missed.">		if (charger != null &amp;&amp; charger.target != null) {</span>

			//inside staff, still need to apply degradation
<span class="nc bnc" id="L393" title="All 2 branches missed.">			if (charger.target == Dungeon.hero</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">					&amp;&amp; !Dungeon.hero.belongings.contains(this)</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">					&amp;&amp; Dungeon.hero.buff( Degrade.class ) != null){</span>
<span class="nc" id="L396">				lvl = Degrade.reduceLevel(lvl);</span>
			}

<span class="nc bnc" id="L399" title="All 2 branches missed.">			if (charger.target.buff(ScrollEmpower.class) != null){</span>
<span class="nc" id="L400">				lvl += 2;</span>
			}

<span class="nc bnc" id="L403" title="All 6 branches missed.">			if (curCharges == 1 &amp;&amp; charger.target instanceof Hero &amp;&amp; ((Hero)charger.target).hasTalent(Talent.DESPERATE_POWER)){</span>
<span class="nc" id="L404">				lvl += ((Hero)charger.target).pointsInTalent(Talent.DESPERATE_POWER);</span>
			}

<span class="nc bnc" id="L407" title="All 2 branches missed.">			if (charger.target.buff(WildMagic.WildMagicTracker.class) != null){</span>
<span class="nc" id="L408">				int bonus = 4 + ((Hero)charger.target).pointsInTalent(Talent.WILD_POWER);</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">				if (Random.Int(2) == 0) bonus++;</span>
<span class="nc" id="L410">				bonus /= 2; // +2/+2.5/+3/+3.5/+4 at 0/1/2/3/4 talent points</span>

<span class="nc" id="L412">				int maxBonusLevel = 3 + ((Hero)charger.target).pointsInTalent(Talent.WILD_POWER);</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">				if (lvl &lt; maxBonusLevel) {</span>
<span class="nc" id="L414">					lvl = Math.min(lvl + bonus, maxBonusLevel);</span>
				}
			}

<span class="nc" id="L418">			WandOfMagicMissile.MagicCharge buff = charger.target.buff(WandOfMagicMissile.MagicCharge.class);</span>
<span class="nc bnc" id="L419" title="All 4 branches missed.">			if (buff != null &amp;&amp; buff.level() &gt; lvl){</span>
<span class="nc" id="L420">				return buff.level();</span>
			}
		}
<span class="nc" id="L423">		return lvl;</span>
	}

	public void updateLevel() {
<span class="nc" id="L427">		maxCharges = Math.min( initialCharges() + level(), 10 );</span>
<span class="nc" id="L428">		curCharges = Math.min( curCharges, maxCharges );</span>
<span class="nc" id="L429">	}</span>
	
	public int initialCharges() {
<span class="nc" id="L432">		return 2;</span>
	}

	protected int chargesPerCast() {
<span class="nc" id="L436">		return 1;</span>
	}
	
	public void fx(Ballistica bolt, Callback callback) {
<span class="nc" id="L440">		MagicMissile.boltFromChar( curUser.sprite.parent,</span>
				MagicMissile.MAGIC_MISSILE,
				curUser.sprite,
<span class="nc" id="L443">				bolt.collisionPos,</span>
				callback);
<span class="nc" id="L445">		Sample.INSTANCE.play( Assets.Sounds.ZAP );</span>
<span class="nc" id="L446">	}</span>

	public void staffFx( MagesStaff.StaffParticle particle ){
<span class="nc" id="L449">		particle.color(0xFFFFFF); particle.am = 0.3f;</span>
<span class="nc" id="L450">		particle.setLifespan( 1f);</span>
<span class="nc" id="L451">		particle.speed.polar( Random.Float(PointF.PI2), 2f );</span>
<span class="nc" id="L452">		particle.setSize( 1f, 2f );</span>
<span class="nc" id="L453">		particle.radiateXY(0.5f);</span>
<span class="nc" id="L454">	}</span>

	public void wandUsed() {
<span class="nc bnc" id="L457" title="All 2 branches missed.">		if (!isIdentified()) {</span>
<span class="nc" id="L458">			float uses = Math.min( availableUsesToID, Talent.itemIDSpeedFactor(Dungeon.hero, this) );</span>
<span class="nc" id="L459">			availableUsesToID -= uses;</span>
<span class="nc" id="L460">			usesLeftToID -= uses;</span>
<span class="nc bnc" id="L461" title="All 4 branches missed.">			if (usesLeftToID &lt;= 0 || Dungeon.hero.pointsInTalent(Talent.SCHOLARS_INTUITION) == 2) {</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">				if (ShardOfOblivion.passiveIDDisabled()){</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">					if (usesLeftToID &gt; -1){</span>
<span class="nc" id="L464">						GLog.p(Messages.get(ShardOfOblivion.class, &quot;identify_ready&quot;), name());</span>
					}
<span class="nc" id="L466">					setIDReady();</span>
				} else {
<span class="nc" id="L468">					identify();</span>
<span class="nc" id="L469">					GLog.p(Messages.get(Wand.class, &quot;identify&quot;));</span>
<span class="nc" id="L470">					Badges.validateItemLevelAquired(this);</span>
				}
			}
<span class="nc bnc" id="L473" title="All 2 branches missed.">			if (ShardOfOblivion.passiveIDDisabled()){</span>
<span class="nc" id="L474">				Buff.prolong(curUser, ShardOfOblivion.WandUseTracker.class, 50f);</span>
			}
		}

		//inside staff
<span class="nc bnc" id="L479" title="All 6 branches missed.">		if (charger != null &amp;&amp; charger.target == Dungeon.hero &amp;&amp; !Dungeon.hero.belongings.contains(this)){</span>
<span class="nc bnc" id="L480" title="All 4 branches missed.">			if (Dungeon.hero.hasTalent(Talent.EXCESS_CHARGE) &amp;&amp; curCharges &gt;= maxCharges){</span>
<span class="nc" id="L481">				int shieldToGive = Math.round(buffedLvl()*0.67f*Dungeon.hero.pointsInTalent(Talent.EXCESS_CHARGE));</span>
<span class="nc" id="L482">				Buff.affect(Dungeon.hero, Barrier.class).setShield(shieldToGive);</span>
<span class="nc" id="L483">				Dungeon.hero.sprite.showStatusWithIcon(CharSprite.POSITIVE, Integer.toString(shieldToGive), FloatingText.SHIELDING);</span>
			}
		}
		
<span class="nc bnc" id="L487" title="All 2 branches missed.">		curCharges -= cursed ? 1 : chargesPerCast();</span>

		//remove magic charge at a higher priority, if we are benefiting from it are and not the
		//wand that just applied it
<span class="nc" id="L491">		WandOfMagicMissile.MagicCharge buff = curUser.buff(WandOfMagicMissile.MagicCharge.class);</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">		if (buff != null</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">				&amp;&amp; buff.wandJustApplied() != this</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">				&amp;&amp; buff.level() == buffedLvl()</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">				&amp;&amp; buffedLvl() &gt; super.buffedLvl()){</span>
<span class="nc" id="L496">			buff.detach();</span>
		} else {
<span class="nc" id="L498">			ScrollEmpower empower = curUser.buff(ScrollEmpower.class);</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">			if (empower != null){</span>
<span class="nc" id="L500">				empower.use();</span>
			}
		}

		//If hero owns wand but it isn't in belongings it must be in the staff
<span class="nc bnc" id="L505" title="All 6 branches missed.">		if (Dungeon.hero.hasTalent(Talent.EMPOWERED_STRIKE)</span>
				&amp;&amp; charger != null &amp;&amp; charger.target == Dungeon.hero
<span class="nc bnc" id="L507" title="All 2 branches missed.">				&amp;&amp; !Dungeon.hero.belongings.contains(this)){</span>

<span class="nc" id="L509">			Buff.prolong(Dungeon.hero, Talent.EmpoweredStrikeTracker.class, 10f);</span>
		}

<span class="nc bnc" id="L512" title="All 6 branches missed.">		if (Dungeon.hero.hasTalent(Talent.LINGERING_MAGIC)</span>
				&amp;&amp; charger != null &amp;&amp; charger.target == Dungeon.hero){

<span class="nc" id="L515">			Buff.prolong(Dungeon.hero, Talent.LingeringMagicTracker.class, 5f);</span>
		}

<span class="nc bnc" id="L518" title="All 2 branches missed.">		if (Dungeon.hero.heroClass != HeroClass.CLERIC</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">				&amp;&amp; Dungeon.hero.hasTalent(Talent.DIVINE_SENSE)){</span>
<span class="nc" id="L520">			Buff.prolong(Dungeon.hero, DivineSense.DivineSenseTracker.class, Dungeon.hero.cooldown()+1);</span>
		}

		// 10/20/30%
<span class="nc bnc" id="L524" title="All 2 branches missed.">		if (Dungeon.hero.heroClass != HeroClass.CLERIC</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">				&amp;&amp; Dungeon.hero.hasTalent(Talent.CLEANSE)</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">				&amp;&amp; Random.Int(10) &lt; Dungeon.hero.pointsInTalent(Talent.CLEANSE)){</span>
<span class="nc" id="L527">			boolean removed = false;</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">			for (Buff b : Dungeon.hero.buffs()) {</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">				if (b.type == Buff.buffType.NEGATIVE) {</span>
<span class="nc" id="L530">					b.detach();</span>
<span class="nc" id="L531">					removed = true;</span>
				}
<span class="nc" id="L533">			}</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">			if (removed) new Flare( 6, 32 ).color(0xFF4CD2, true).show( Dungeon.hero.sprite, 2f );</span>
		}

<span class="nc" id="L537">		Invisibility.dispel();</span>
<span class="nc" id="L538">		updateQuickslot();</span>

<span class="nc" id="L540">		curUser.spendAndNext( TIME_TO_ZAP );</span>
<span class="nc" id="L541">	}</span>
	
	@Override
	public Item random() {
		//+0: 66.67% (2/3)
		//+1: 26.67% (4/15)
		//+2: 6.67%  (1/15)
<span class="nc" id="L548">		int n = 0;</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">		if (Random.Int(3) == 0) {</span>
<span class="nc" id="L550">			n++;</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">			if (Random.Int(5) == 0){</span>
<span class="nc" id="L552">				n++;</span>
			}
		}
<span class="nc" id="L555">		level(n);</span>
<span class="nc" id="L556">		curCharges += n;</span>
		
		//30% chance to be cursed
<span class="nc bnc" id="L559" title="All 2 branches missed.">		if (Random.Float() &lt; 0.3f) {</span>
<span class="nc" id="L560">			cursed = true;</span>
		}

<span class="nc" id="L563">		return this;</span>
	}

	@Override
	public ItemSprite.Glowing glowing() {
<span class="nc bnc" id="L568" title="All 2 branches missed.">		if (resinBonus == 0) return null;</span>

<span class="nc" id="L570">		return new ItemSprite.Glowing(0xFFFFFF, 1f/(float)resinBonus);</span>
	}

	@Override
	public int value() {
<span class="nc" id="L575">		int price = 75;</span>
<span class="nc bnc" id="L576" title="All 4 branches missed.">		if (cursed &amp;&amp; cursedKnown) {</span>
<span class="nc" id="L577">			price /= 2;</span>
		}
<span class="nc bnc" id="L579" title="All 2 branches missed.">		if (levelKnown) {</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">			if (level() &gt; 0) {</span>
<span class="nc" id="L581">				price *= (level() + 1);</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">			} else if (level() &lt; 0) {</span>
<span class="nc" id="L583">				price /= (1 - level());</span>
			}
		}
<span class="nc bnc" id="L586" title="All 2 branches missed.">		if (price &lt; 1) {</span>
<span class="nc" id="L587">			price = 1;</span>
		}
<span class="nc" id="L589">		return price;</span>
	}
	
	private static final String USES_LEFT_TO_ID     = &quot;uses_left_to_id&quot;;
	private static final String AVAILABLE_USES      = &quot;available_uses&quot;;
	private static final String CUR_CHARGES         = &quot;curCharges&quot;;
	private static final String CUR_CHARGE_KNOWN    = &quot;curChargeKnown&quot;;
	private static final String PARTIALCHARGE       = &quot;partialCharge&quot;;
	private static final String CURSE_INFUSION_BONUS= &quot;curse_infusion_bonus&quot;;
	private static final String RESIN_BONUS         = &quot;resin_bonus&quot;;

	@Override
	public void storeInBundle( Bundle bundle ) {
<span class="nc" id="L602">		super.storeInBundle( bundle );</span>
<span class="nc" id="L603">		bundle.put( USES_LEFT_TO_ID, usesLeftToID );</span>
<span class="nc" id="L604">		bundle.put( AVAILABLE_USES, availableUsesToID );</span>
<span class="nc" id="L605">		bundle.put( CUR_CHARGES, curCharges );</span>
<span class="nc" id="L606">		bundle.put( CUR_CHARGE_KNOWN, curChargeKnown );</span>
<span class="nc" id="L607">		bundle.put( PARTIALCHARGE , partialCharge );</span>
<span class="nc" id="L608">		bundle.put( CURSE_INFUSION_BONUS, curseInfusionBonus );</span>
<span class="nc" id="L609">		bundle.put( RESIN_BONUS, resinBonus );</span>
<span class="nc" id="L610">	}</span>
	
	@Override
	public void restoreFromBundle( Bundle bundle ) {
<span class="nc" id="L614">		super.restoreFromBundle( bundle );</span>
<span class="nc" id="L615">		usesLeftToID = bundle.getInt( USES_LEFT_TO_ID );</span>
<span class="nc" id="L616">		availableUsesToID = bundle.getInt( AVAILABLE_USES );</span>
<span class="nc" id="L617">		curseInfusionBonus = bundle.getBoolean(CURSE_INFUSION_BONUS);</span>
<span class="nc" id="L618">		resinBonus = bundle.getInt(RESIN_BONUS);</span>

<span class="nc" id="L620">		updateLevel();</span>

<span class="nc" id="L622">		curCharges = bundle.getInt( CUR_CHARGES );</span>
<span class="nc" id="L623">		curChargeKnown = bundle.getBoolean( CUR_CHARGE_KNOWN );</span>
<span class="nc" id="L624">		partialCharge = bundle.getFloat( PARTIALCHARGE );</span>
<span class="nc" id="L625">	}</span>
	
	@Override
	public void reset() {
<span class="nc" id="L629">		super.reset();</span>
<span class="nc" id="L630">		usesLeftToID = USES_TO_ID;</span>
<span class="nc" id="L631">		availableUsesToID = USES_TO_ID/2f;</span>
<span class="nc" id="L632">	}</span>

	public int collisionProperties(int target){
<span class="nc bnc" id="L635" title="All 2 branches missed.">		if (cursed)     return Ballistica.MAGIC_BOLT;</span>
<span class="nc" id="L636">		else            return collisionProperties;</span>
	}

<span class="nc" id="L639">	public static class PlaceHolder extends Wand {</span>

		{
<span class="nc" id="L642">			image = ItemSpriteSheet.WAND_HOLDER;</span>
<span class="nc" id="L643">		}</span>

		@Override
		public boolean isSimilar(Item item) {
<span class="nc" id="L647">			return item instanceof Wand;</span>
		}

		@Override
<span class="nc" id="L651">		public void onZap(Ballistica attack) {}</span>
<span class="nc" id="L652">		public void onHit(MagesStaff staff, Char attacker, Char defender, int damage) {}</span>

		@Override
		public String info() {
<span class="nc" id="L656">			return &quot;&quot;;</span>
		}
	}
	
<span class="nc" id="L660">	protected static CellSelector.Listener zapper = new  CellSelector.Listener() {</span>
		
		@Override
		public void onSelect( Integer target ) {
			
<span class="nc bnc" id="L665" title="All 2 branches missed.">			if (target != null) {</span>
				
				//FIXME this safety check shouldn't be necessary
				//it would be better to eliminate the curItem static variable.
				final Wand curWand;
<span class="nc bnc" id="L670" title="All 2 branches missed.">				if (curItem instanceof Wand) {</span>
<span class="nc" id="L671">					curWand = (Wand) Wand.curItem;</span>
				} else {
<span class="nc" id="L673">					return;</span>
				}

<span class="nc" id="L676">				final Ballistica shot = new Ballistica( curUser.pos, target, curWand.collisionProperties(target));</span>
<span class="nc" id="L677">				int cell = shot.collisionPos;</span>
				
<span class="nc bnc" id="L679" title="All 4 branches missed.">				if (target == curUser.pos || cell == curUser.pos) {</span>
<span class="nc bnc" id="L680" title="All 4 branches missed.">					if (target == curUser.pos &amp;&amp; curUser.hasTalent(Talent.SHIELD_BATTERY)){</span>

<span class="nc bnc" id="L682" title="All 2 branches missed.">						if (curUser.buff(MagicImmune.class) != null){</span>
<span class="nc" id="L683">							GLog.w( Messages.get(Wand.class, &quot;no_magic&quot;) );</span>
<span class="nc" id="L684">							return;</span>
						}

<span class="nc bnc" id="L687" title="All 2 branches missed.">						if (curWand.curCharges == 0){</span>
<span class="nc" id="L688">							GLog.w( Messages.get(Wand.class, &quot;fizzles&quot;) );</span>
<span class="nc" id="L689">							return;</span>
						}

<span class="nc" id="L692">						float shield = curUser.HT * (0.04f*curWand.curCharges);</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">						if (curUser.pointsInTalent(Talent.SHIELD_BATTERY) == 2) shield *= 1.5f;</span>
<span class="nc" id="L694">						Buff.affect(curUser, Barrier.class).setShield(Math.round(shield));</span>
<span class="nc" id="L695">						curUser.sprite.showStatusWithIcon(CharSprite.POSITIVE, Integer.toString(Math.round(shield)), FloatingText.SHIELDING);</span>
<span class="nc" id="L696">						curWand.curCharges = 0;</span>
<span class="nc" id="L697">						curUser.sprite.operate(curUser.pos);</span>
<span class="nc" id="L698">						Sample.INSTANCE.play(Assets.Sounds.CHARGEUP);</span>
<span class="nc" id="L699">						ScrollOfRecharging.charge(curUser);</span>
<span class="nc" id="L700">						updateQuickslot();</span>
<span class="nc" id="L701">						curUser.spendAndNext(Actor.TICK);</span>
<span class="nc" id="L702">						return;</span>
					}
<span class="nc" id="L704">					GLog.i( Messages.get(Wand.class, &quot;self_target&quot;) );</span>
<span class="nc" id="L705">					return;</span>
				}

<span class="nc" id="L708">				curUser.sprite.zap(cell);</span>

				//attempts to target the cell aimed at if something is there, otherwise targets the collision pos.
<span class="nc bnc" id="L711" title="All 2 branches missed.">				if (Actor.findChar(target) != null)</span>
<span class="nc" id="L712">					QuickSlotButton.target(Actor.findChar(target));</span>
				else
<span class="nc" id="L714">					QuickSlotButton.target(Actor.findChar(cell));</span>
				
<span class="nc bnc" id="L716" title="All 2 branches missed.">				if (curWand.tryToZap(curUser, target)) {</span>
					
<span class="nc" id="L718">					curUser.busy();</span>

					//backup barrier logic
					//This triggers before the wand zap, mostly so the barrier helps vs skeletons
<span class="nc bnc" id="L722" title="All 2 branches missed.">					if (curUser.hasTalent(Talent.BACKUP_BARRIER)</span>
<span class="nc bnc" id="L723" title="All 4 branches missed.">							&amp;&amp; curWand.curCharges == curWand.chargesPerCast()</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">							&amp;&amp; curWand.charger != null &amp;&amp; curWand.charger.target == curUser){</span>

						//regular. If hero owns wand but it isn't in belongings it must be in the staff
<span class="nc bnc" id="L727" title="All 4 branches missed.">						if (curUser.heroClass == HeroClass.MAGE &amp;&amp; !curUser.belongings.contains(curWand)){</span>
							//grants 3/5 shielding
<span class="nc" id="L729">							int shieldToGive = 1 + 2 * Dungeon.hero.pointsInTalent(Talent.BACKUP_BARRIER);</span>
<span class="nc" id="L730">							Buff.affect(Dungeon.hero, Barrier.class).setShield(shieldToGive);</span>
<span class="nc" id="L731">							Dungeon.hero.sprite.showStatusWithIcon(CharSprite.POSITIVE, Integer.toString(shieldToGive), FloatingText.SHIELDING);</span>

						//metamorphed. Triggers if wand is highest level hero has
<span class="nc bnc" id="L734" title="All 2 branches missed.">						} else if (curUser.heroClass != HeroClass.MAGE) {</span>
<span class="nc" id="L735">							boolean highest = true;</span>
<span class="nc bnc" id="L736" title="All 2 branches missed.">							for (Item i : curUser.belongings.getAllItems(Wand.class)){</span>
<span class="nc bnc" id="L737" title="All 2 branches missed.">								if (i.level() &gt; curWand.level()){</span>
<span class="nc" id="L738">									highest = false;</span>
								}
<span class="nc" id="L740">							}</span>
<span class="nc bnc" id="L741" title="All 2 branches missed.">							if (highest){</span>
								//grants 3/5 shielding
<span class="nc" id="L743">								int shieldToGive = 1 + 2 * Dungeon.hero.pointsInTalent(Talent.BACKUP_BARRIER);</span>
<span class="nc" id="L744">								Buff.affect(Dungeon.hero, Barrier.class).setShield(shieldToGive);</span>
<span class="nc" id="L745">								Dungeon.hero.sprite.showStatusWithIcon(CharSprite.POSITIVE, Integer.toString(shieldToGive), FloatingText.SHIELDING);</span>
							}
						}
					}
					
<span class="nc bnc" id="L750" title="All 2 branches missed.">					if (curWand.cursed){</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">						if (!curWand.cursedKnown){</span>
<span class="nc" id="L752">							GLog.n(Messages.get(Wand.class, &quot;curse_discover&quot;, curWand.name()));</span>
						}
<span class="nc" id="L754">						CursedWand.cursedZap(curWand,</span>
<span class="nc" id="L755">								curUser,</span>
<span class="nc" id="L756">								new Ballistica(curUser.pos, target, Ballistica.MAGIC_BOLT),</span>
<span class="nc" id="L757">								new Callback() {</span>
									@Override
									public void call() {
<span class="nc" id="L760">										curWand.wandUsed();</span>
<span class="nc" id="L761">									}</span>
								});
					} else {
<span class="nc" id="L764">						curWand.fx(shot, new Callback() {</span>
							public void call() {
<span class="nc" id="L766">								curWand.onZap(shot);</span>
<span class="nc bnc" id="L767" title="All 2 branches missed.">								if (Random.Float() &lt; WondrousResin.extraCurseEffectChance()){</span>
<span class="nc" id="L768">									WondrousResin.forcePositive = true;</span>
<span class="nc" id="L769">									CursedWand.cursedZap(curWand,</span>
<span class="nc" id="L770">											curUser,</span>
<span class="nc" id="L771">											new Ballistica(curUser.pos, target, Ballistica.MAGIC_BOLT), new Callback() {</span>
												@Override
												public void call() {
<span class="nc" id="L774">													WondrousResin.forcePositive = false;</span>
<span class="nc" id="L775">													curWand.wandUsed();</span>
<span class="nc" id="L776">												}</span>
											});
								} else {
<span class="nc" id="L779">									curWand.wandUsed();</span>
								}
<span class="nc" id="L781">							}</span>
						});

					}
<span class="nc" id="L785">					curWand.cursedKnown = true;</span>
					
				}
				
			}
<span class="nc" id="L790">		}</span>
		
		@Override
		public String prompt() {
<span class="nc" id="L794">			return Messages.get(Wand.class, &quot;prompt&quot;);</span>
		}
	};
	
<span class="nc" id="L798">	public class Charger extends Buff {</span>
		
		private static final float BASE_CHARGE_DELAY = 10f;
		private static final float SCALING_CHARGE_ADDITION = 40f;
		private static final float NORMAL_SCALE_FACTOR = 0.875f;

		private static final float CHARGE_BUFF_BONUS = 0.25f;

<span class="nc" id="L806">		float scalingFactor = NORMAL_SCALE_FACTOR;</span>

		@Override
		public boolean attachTo( Char target ) {
<span class="nc bnc" id="L810" title="All 2 branches missed.">			if (super.attachTo( target )) {</span>
				//if we're loading in and the hero has partially spent a turn, delay for 1 turn
<span class="nc bnc" id="L812" title="All 8 branches missed.">				if (target instanceof Hero &amp;&amp; Dungeon.hero == null &amp;&amp; cooldown() == 0 &amp;&amp; target.cooldown() &gt; 0) {</span>
<span class="nc" id="L813">					spend(TICK);</span>
				}
<span class="nc" id="L815">				return true;</span>
			}
<span class="nc" id="L817">			return false;</span>
		}
		
		@Override
		public boolean act() {
<span class="nc bnc" id="L822" title="All 4 branches missed.">			if (curCharges &lt; maxCharges &amp;&amp; target.buff(MagicImmune.class) == null)</span>
<span class="nc" id="L823">				recharge();</span>
			
<span class="nc bnc" id="L825" title="All 4 branches missed.">			while (partialCharge &gt;= 1 &amp;&amp; curCharges &lt; maxCharges) {</span>
<span class="nc" id="L826">				partialCharge--;</span>
<span class="nc" id="L827">				curCharges++;</span>
<span class="nc" id="L828">				updateQuickslot();</span>
			}
			
<span class="nc bnc" id="L831" title="All 2 branches missed.">			if (curCharges == maxCharges){</span>
<span class="nc" id="L832">				partialCharge = 0;</span>
			}
			
<span class="nc" id="L835">			spend( TICK );</span>
			
<span class="nc" id="L837">			return true;</span>
		}

		private void recharge(){
<span class="nc" id="L841">			int missingCharges = maxCharges - curCharges;</span>
<span class="nc" id="L842">			missingCharges = Math.max(0, missingCharges);</span>

<span class="nc" id="L844">			float turnsToCharge = (float) (BASE_CHARGE_DELAY</span>
<span class="nc" id="L845">					+ (SCALING_CHARGE_ADDITION * Math.pow(scalingFactor, missingCharges)));</span>

<span class="nc bnc" id="L847" title="All 2 branches missed.">			if (Regeneration.regenOn())</span>
<span class="nc" id="L848">				partialCharge += (1f/turnsToCharge) * RingOfEnergy.wandChargeMultiplier(target);</span>

<span class="nc bnc" id="L850" title="All 2 branches missed.">			for (Recharging bonus : target.buffs(Recharging.class)){</span>
<span class="nc bnc" id="L851" title="All 4 branches missed.">				if (bonus != null &amp;&amp; bonus.remainder() &gt; 0f) {</span>
<span class="nc" id="L852">					partialCharge += CHARGE_BUFF_BONUS * bonus.remainder();</span>
				}
<span class="nc" id="L854">			}</span>
<span class="nc" id="L855">		}</span>
		
		public Wand wand(){
<span class="nc" id="L858">			return Wand.this;</span>
		}

		public void gainCharge(float charge){
<span class="nc bnc" id="L862" title="All 2 branches missed.">			if (curCharges &lt; maxCharges) {</span>
<span class="nc" id="L863">				partialCharge += charge;</span>
<span class="nc bnc" id="L864" title="All 2 branches missed.">				while (partialCharge &gt;= 1f) {</span>
<span class="nc" id="L865">					curCharges++;</span>
<span class="nc" id="L866">					partialCharge--;</span>
				}
<span class="nc bnc" id="L868" title="All 2 branches missed.">				if (curCharges &gt;= maxCharges){</span>
<span class="nc" id="L869">					partialCharge = 0;</span>
<span class="nc" id="L870">					curCharges = maxCharges;</span>
				}
<span class="nc" id="L872">				updateQuickslot();</span>
			}
<span class="nc" id="L874">		}</span>

		private void setScaleFactor(float value){
<span class="nc" id="L877">			this.scalingFactor = value;</span>
<span class="nc" id="L878">		}</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>