<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InterlevelScene.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">core</a> &gt; <a href="index.source.html" class="el_package">com.shatteredpixel.shatteredpixeldungeon.scenes</a> &gt; <span class="el_source">InterlevelScene.java</span></div><h1>InterlevelScene.java</h1><pre class="source lang-java linenums">/*
 * Pixel Dungeon
 * Copyright (C) 2012-2015 Oleg Dolya
 *
 * Shattered Pixel Dungeon
 * Copyright (C) 2014-2024 Evan Debenham
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;
 */

package com.shatteredpixel.shatteredpixeldungeon.scenes;

import com.shatteredpixel.shatteredpixeldungeon.Assets;
import com.shatteredpixel.shatteredpixeldungeon.Chrome;
import com.shatteredpixel.shatteredpixeldungeon.Dungeon;
import com.shatteredpixel.shatteredpixeldungeon.GamesInProgress;
import com.shatteredpixel.shatteredpixeldungeon.ShatteredPixelDungeon;
import com.shatteredpixel.shatteredpixeldungeon.Statistics;
import com.shatteredpixel.shatteredpixeldungeon.actors.Actor;
import com.shatteredpixel.shatteredpixeldungeon.actors.buffs.Buff;
import com.shatteredpixel.shatteredpixeldungeon.actors.mobs.Mob;
import com.shatteredpixel.shatteredpixeldungeon.effects.ShadowBox;
import com.shatteredpixel.shatteredpixeldungeon.items.Item;
import com.shatteredpixel.shatteredpixeldungeon.items.LostBackpack;
import com.shatteredpixel.shatteredpixeldungeon.journal.Document;
import com.shatteredpixel.shatteredpixeldungeon.levels.Level;
import com.shatteredpixel.shatteredpixeldungeon.levels.Terrain;
import com.shatteredpixel.shatteredpixeldungeon.levels.features.Chasm;
import com.shatteredpixel.shatteredpixeldungeon.levels.features.LevelTransition;
import com.shatteredpixel.shatteredpixeldungeon.levels.rooms.special.SpecialRoom;
import com.shatteredpixel.shatteredpixeldungeon.messages.Messages;
import com.shatteredpixel.shatteredpixeldungeon.ui.GameLog;
import com.shatteredpixel.shatteredpixeldungeon.ui.IconButton;
import com.shatteredpixel.shatteredpixeldungeon.ui.Icons;
import com.shatteredpixel.shatteredpixeldungeon.ui.RenderedTextBlock;
import com.shatteredpixel.shatteredpixeldungeon.ui.StyledButton;
import com.shatteredpixel.shatteredpixeldungeon.windows.WndError;
import com.watabou.gltextures.TextureCache;
import com.watabou.input.KeyEvent;
import com.watabou.noosa.Camera;
import com.watabou.noosa.Game;
import com.watabou.noosa.Image;
import com.watabou.noosa.tweeners.Tweener;
import com.watabou.utils.BArray;
import com.watabou.utils.DeviceCompat;
import com.watabou.utils.GameMath;
import com.watabou.utils.Random;
import com.watabou.utils.Signal;

import java.io.FileNotFoundException;
import java.io.IOException;
import java.util.ArrayList;

<span class="nc" id="L65">public class InterlevelScene extends PixelScene {</span>
	
	//slow fade on entering a new region
	private static final float SLOW_FADE = 1f; //.33 in, 1.33 steady, .33 out, 2 seconds total
	//norm fade when loading, falling, returning, or descending to a new floor
	private static final float NORM_FADE = 0.67f; //.33 in, .67 steady, .33 out, 1.33 seconds total
	//fast fade when ascending, or descending to a floor you've been on
	private static final float FAST_FADE = 0.50f; //.33 in, .33 steady, .33 out, 1 second total
	
	private static float fadeTime;
	
<span class="nc" id="L76">	public enum Mode {</span>
<span class="nc" id="L77">		DESCEND, ASCEND, CONTINUE, RESURRECT, RETURN, FALL, RESET, NONE</span>
	}
	public static Mode mode;

<span class="nc" id="L81">	public static LevelTransition curTransition = null;</span>
	public static int returnDepth;
	public static int returnBranch;
	public static int returnPos;

	public static boolean fallIntoPit;
	
<span class="nc" id="L88">	private enum Phase {</span>
<span class="nc" id="L89">		FADE_IN, STATIC, FADE_OUT</span>
	}
	private Phase phase;
	private float timeLeft;

	public Image background;

	private RenderedTextBlock loadingText;

	private RenderedTextBlock storyMessage;
	private ShadowBox storyBG;
	private StyledButton btnContinue;
	private IconButton btnHideStory;
	
	private static Thread thread;
<span class="nc" id="L104">	private static Exception error = null;</span>
	private float waitingTime;

<span class="nc" id="L107">	public static int lastRegion = -1;</span>

	{
<span class="nc" id="L110">		inGameScene = true;</span>
	}
	
	@Override
	public void create() {
<span class="nc" id="L115">		super.create();</span>
		
		String loadingAsset;
		int loadingDepth;
<span class="nc" id="L119">		fadeTime = NORM_FADE;</span>

<span class="nc" id="L121">		long seed = Dungeon.seed;</span>
<span class="nc bnc" id="L122" title="All 6 branches missed.">		switch (mode){</span>
			default:
<span class="nc" id="L124">				loadingDepth = Dungeon.depth;</span>
<span class="nc" id="L125">				break;</span>
			case CONTINUE:
<span class="nc" id="L127">				loadingDepth = GamesInProgress.check(GamesInProgress.curSlot).depth;</span>
<span class="nc" id="L128">				seed = GamesInProgress.check(GamesInProgress.curSlot).seed;</span>
<span class="nc" id="L129">				break;</span>
			case DESCEND:
<span class="nc bnc" id="L131" title="All 2 branches missed.">				if (Dungeon.hero == null){</span>
<span class="nc" id="L132">					loadingDepth = 1;</span>
<span class="nc" id="L133">					fadeTime = SLOW_FADE;</span>
				} else {
<span class="nc bnc" id="L135" title="All 2 branches missed.">					if (curTransition != null)  loadingDepth = curTransition.destDepth;</span>
<span class="nc" id="L136">					else                        loadingDepth = Dungeon.depth+1;</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">					if (Statistics.deepestFloor &gt;= loadingDepth) {</span>
<span class="nc" id="L138">						fadeTime = FAST_FADE;</span>
<span class="nc bnc" id="L139" title="All 10 branches missed.">					} else if (loadingDepth == 6 || loadingDepth == 11</span>
							|| loadingDepth == 16 || loadingDepth == 21 || loadingDepth == 26) {
<span class="nc" id="L141">						fadeTime = SLOW_FADE;</span>
					}
				}
				break;
			case FALL:
<span class="nc" id="L146">				loadingDepth = Dungeon.depth+1;</span>
<span class="nc" id="L147">				break;</span>
			case ASCEND:
<span class="nc" id="L149">				fadeTime = FAST_FADE;</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">				if (curTransition != null)  loadingDepth = curTransition.destDepth;</span>
<span class="nc" id="L151">				else                        loadingDepth = Dungeon.depth-1;</span>
<span class="nc" id="L152">				break;</span>
			case RETURN:
<span class="nc" id="L154">				loadingDepth = returnDepth;</span>
				break;
		}

		//flush the texture cache whenever moving between regions, helps reduce memory load
<span class="nc" id="L159">		int region = (int)Math.ceil(loadingDepth / 5f);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">		if (region != lastRegion){</span>
<span class="nc" id="L161">			TextureCache.clear();</span>
<span class="nc" id="L162">			lastRegion = region;</span>
		}

<span class="nc" id="L165">		int loadingCenter = 400;</span>

		//for portrait users, each run the splashes change what details they focus on
<span class="nc" id="L168">		Random.pushGenerator(seed+lastRegion);</span>
<span class="nc bnc" id="L169" title="All 5 branches missed.">			switch (lastRegion){</span>
				case 1:
<span class="nc" id="L171">					loadingAsset = Assets.Splashes.SEWERS;</span>
<span class="nc bnc" id="L172" title="All 3 branches missed.">					switch (Random.Int(2)){</span>
<span class="nc" id="L173">						case 0: loadingCenter = 180; break; //focus on rats and left side</span>
<span class="nc" id="L174">						case 1: loadingCenter = 485; break; //focus on center pipe and door</span>
					}
<span class="nc" id="L176">					break;</span>
				case 2:
<span class="nc" id="L178">					loadingAsset = Assets.Splashes.PRISON;</span>
<span class="nc bnc" id="L179" title="All 3 branches missed.">					switch (Random.Int(3)){</span>
<span class="nc" id="L180">						case 0: loadingCenter = 190; break; //focus on left skeleton</span>
<span class="nc" id="L181">						case 1: loadingCenter = 402; break; //focus on center arch</span>
					}
<span class="nc" id="L183">					break;</span>
				case 3:
<span class="nc" id="L185">					loadingAsset = Assets.Splashes.CAVES;</span>
<span class="nc bnc" id="L186" title="All 3 branches missed.">					switch (Random.Int(3)){</span>
<span class="nc" id="L187">						case 0: loadingCenter = 340; break; //focus on center gnoll groups</span>
<span class="nc" id="L188">						case 1: loadingCenter = 625; break; //focus on right gnoll</span>
					}
<span class="nc" id="L190">					break;</span>
				case 4:
<span class="nc" id="L192">					loadingAsset = Assets.Splashes.CITY;</span>
<span class="nc bnc" id="L193" title="All 3 branches missed.">					switch (Random.Int(3)){</span>
<span class="nc" id="L194">						case 0: loadingCenter = 275; break; //focus on left bookcases</span>
<span class="nc" id="L195">						case 1: loadingCenter = 485; break; //focus on center pathway</span>
					}
<span class="nc" id="L197">					break;</span>
				case 5: default:
<span class="nc" id="L199">					loadingAsset = Assets.Splashes.HALLS;</span>
<span class="nc bnc" id="L200" title="All 3 branches missed.">					switch (Random.Int(3)){</span>
<span class="nc" id="L201">						case 0: loadingCenter = 145; break; //focus on left arches</span>
<span class="nc" id="L202">						case 1: loadingCenter = 400; break; //focus on ripper demon</span>
					}
					break;
			}
<span class="nc" id="L206">		Random.popGenerator();</span>
		
<span class="nc bnc" id="L208" title="All 2 branches missed.">		if (DeviceCompat.isDebug()){</span>
<span class="nc" id="L209">			fadeTime = 0f;</span>
		}

<span class="nc" id="L212">		background = new Image(loadingAsset);</span>
<span class="nc" id="L213">		background.scale.set(Camera.main.height/background.height);</span>

<span class="nc bnc" id="L215" title="All 2 branches missed.">		if (Camera.main.width &gt;= background.width()){</span>
<span class="nc" id="L216">			background.x = (Camera.main.width - background.width())/2f;</span>
		} else {
<span class="nc" id="L218">			background.x = Camera.main.width/2f - loadingCenter*background.scale.x;</span>
<span class="nc" id="L219">			background.x = GameMath.gate(Camera.main.width - background.width(), background.x, 0);</span>
		}
<span class="nc" id="L221">		background.y = (Camera.main.height - background.height())/2f;</span>
<span class="nc" id="L222">		PixelScene.align(background);</span>
<span class="nc" id="L223">		add(background);</span>

		Image fadeLeft, fadeRight;
<span class="nc" id="L226">		fadeLeft = new Image(TextureCache.createGradient(0xFF000000, 0xFF000000, 0x00000000));</span>
<span class="nc" id="L227">		fadeLeft.x = background.x-2;</span>
<span class="nc" id="L228">		fadeLeft.scale.set(3, background.height());</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">		fadeLeft.visible = background.x &gt; 0;</span>
<span class="nc" id="L230">		add(fadeLeft);</span>

<span class="nc" id="L232">		fadeRight = new Image(fadeLeft);</span>
<span class="nc" id="L233">		fadeRight.x = background.x + background.width() + 2;</span>
<span class="nc" id="L234">		fadeRight.y = background.y + background.height();</span>
<span class="nc" id="L235">		fadeRight.angle = 180;</span>
<span class="nc" id="L236">		fadeRight.visible = fadeLeft.visible;</span>
<span class="nc" id="L237">		add(fadeRight);</span>

<span class="nc" id="L239">		Image im = new Image(TextureCache.createGradient(0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xFF000000)){</span>
			@Override
			public void update() {
<span class="nc" id="L242">				super.update();</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">				if (lastRegion == 6)                aa = 1;</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">				else if (phase == Phase.FADE_IN)    aa = Math.max( 0, 2*(timeLeft - (fadeTime - 0.333f)));</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">				else if (phase == Phase.FADE_OUT)   aa = Math.max( 0, 2*(0.333f - timeLeft));</span>
				//else                                aa = 0;
<span class="nc" id="L247">			}</span>
		};
<span class="nc" id="L249">		im.angle = 90;</span>
<span class="nc" id="L250">		im.x = Camera.main.width;</span>
<span class="nc" id="L251">		im.scale.x = Camera.main.height/5f;</span>
<span class="nc" id="L252">		im.scale.y = Camera.main.width;</span>
<span class="nc" id="L253">		add(im);</span>

<span class="nc" id="L255">		String text = Messages.get(Mode.class, mode.name());</span>
		
<span class="nc" id="L257">		loadingText = PixelScene.renderTextBlock( text, 9 );</span>
<span class="nc" id="L258">		loadingText.setPos(</span>
<span class="nc" id="L259">				(Camera.main.width - loadingText.width() - 8),</span>
<span class="nc" id="L260">				(Camera.main.height - loadingText.height() - 6)</span>
		);
<span class="nc" id="L262">		align(loadingText);</span>
<span class="nc" id="L263">		add(loadingText);</span>

<span class="nc bnc" id="L265" title="All 6 branches missed.">		if (mode == Mode.DESCEND &amp;&amp; lastRegion &lt;= 5 &amp;&amp; !DeviceCompat.isDebug()){</span>
<span class="nc bnc" id="L266" title="All 6 branches missed.">			if (Dungeon.hero == null || (loadingDepth &gt; Statistics.deepestFloor &amp;&amp; loadingDepth % 5 == 1)){</span>
<span class="nc" id="L267">					storyMessage = PixelScene.renderTextBlock(Document.INTROS.pageBody(region), 6);</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">					storyMessage.maxWidth( PixelScene.landscape() ? 180 : 125);</span>
<span class="nc" id="L269">					storyMessage.setPos((Camera.main.width-storyMessage.width())/2f, (Camera.main.height-storyMessage.height())/2f);</span>

<span class="nc" id="L271">					storyBG = new ShadowBox();</span>
<span class="nc" id="L272">					storyBG.boxRect(storyMessage.left()-10, storyMessage.top()-10, storyMessage.width()+20, storyMessage.height()+20);</span>
<span class="nc" id="L273">					storyBG.alpha(0.8f);</span>
<span class="nc" id="L274">					add(storyBG);</span>
<span class="nc" id="L275">					add(storyMessage);</span>

<span class="nc" id="L277">					btnContinue = new StyledButton(Chrome.Type.TOAST_TR, Messages.get(InterlevelScene.class, &quot;continue&quot;), 9){</span>
						@Override
						protected void onClick() {
<span class="nc" id="L280">							phase = Phase.FADE_OUT;</span>
<span class="nc" id="L281">							timeLeft = fadeTime;</span>

<span class="nc" id="L283">							btnContinue.enable(false);</span>
<span class="nc" id="L284">							Document.INTROS.readPage(region);</span>
<span class="nc" id="L285">						}</span>
					};
<span class="nc" id="L287">					btnContinue.icon(Icons.STAIRS.get());</span>
<span class="nc" id="L288">					btnContinue.setSize(btnContinue.reqWidth()+10, 22);</span>
<span class="nc" id="L289">					btnContinue.visible = false;</span>
<span class="nc" id="L290">					btnContinue.enable(false);</span>

<span class="nc" id="L292">					KeyEvent.addKeyListener(new Signal.Listener&lt;KeyEvent&gt;() {</span>
						@Override
						public boolean onSignal(KeyEvent keyEvent) {
<span class="nc bnc" id="L295" title="All 4 branches missed.">							if (!keyEvent.pressed &amp;&amp; btnContinue.active){</span>
<span class="nc bnc" id="L296" title="All 4 branches missed.">								if (btnHideStory.active &amp;&amp; !btnHideStory.icon().visible){</span>
<span class="nc" id="L297">									btnHideStory.setRect(btnContinue.right()+2, btnContinue.top(), 20, 21);</span>
<span class="nc" id="L298">									align(btnHideStory);</span>
<span class="nc" id="L299">									btnHideStory.icon().visible = true;</span>
<span class="nc" id="L300">									btnHideStory.parent.add(new Tweener(parent, 0.5f) {</span>
										@Override
										protected void updateValues(float progress) {
<span class="nc" id="L303">											float uiAlpha = progress;</span>
<span class="nc" id="L304">											btnContinue.alpha(uiAlpha);</span>
<span class="nc" id="L305">											storyBG.alpha(uiAlpha*0.8f);</span>
<span class="nc" id="L306">											storyMessage.alpha(uiAlpha);</span>
<span class="nc" id="L307">											btnHideStory.icon().alpha(uiAlpha);</span>
<span class="nc" id="L308">											loadingText.alpha(uiAlpha);</span>
<span class="nc" id="L309">											im.am = uiAlpha;</span>
<span class="nc" id="L310">										}</span>
									});
								} else {
<span class="nc" id="L313">									phase = Phase.FADE_OUT;</span>
<span class="nc" id="L314">									timeLeft = fadeTime;</span>
<span class="nc" id="L315">									btnContinue.enable(false);</span>
<span class="nc" id="L316">									Document.INTROS.readPage(region);</span>
								}
<span class="nc" id="L318">								return true;</span>
							}
<span class="nc" id="L320">							return false;</span>
						}
					});

<span class="nc" id="L324">					btnContinue.setPos((Camera.main.width - btnContinue.width())/2f, storyMessage.bottom()+10);</span>
<span class="nc" id="L325">					add(btnContinue);</span>

<span class="nc" id="L327">					btnHideStory = new IconButton(Icons.CHEVRON.get()){</span>
						@Override
						protected void onClick() {
<span class="nc bnc" id="L330" title="All 4 branches missed.">							if (btnContinue.alpha() != 0 &amp;&amp; btnContinue.alpha() != 1){</span>
<span class="nc" id="L331">								return;</span>
							}
<span class="nc bnc" id="L333" title="All 2 branches missed.">							if (icon.visible) {</span>
<span class="nc" id="L334">								enable(false);</span>
								//button is effectively screen-sized, but invisible
<span class="nc" id="L336">								parent.add(new Tweener(parent, 0.5f) {</span>
									@Override
									protected void updateValues(float progress) {
<span class="nc" id="L339">										float uiAlpha = 1 - progress;</span>
<span class="nc" id="L340">										btnContinue.alpha(uiAlpha);</span>
<span class="nc" id="L341">										storyBG.alpha(uiAlpha * 0.8f);</span>
<span class="nc" id="L342">										storyMessage.alpha(uiAlpha);</span>
<span class="nc" id="L343">										icon.alpha(uiAlpha);</span>
<span class="nc" id="L344">										loadingText.alpha(uiAlpha);</span>
<span class="nc" id="L345">										im.am = uiAlpha;</span>
<span class="nc" id="L346">									}</span>

									@Override
									protected void onComplete() {
<span class="nc" id="L350">										super.onComplete();</span>
<span class="nc" id="L351">										setRect(0, 0, Camera.main.width, Camera.main.height);</span>
<span class="nc" id="L352">										enable(true);</span>
<span class="nc" id="L353">										icon.visible = false;</span>
<span class="nc" id="L354">									}</span>
								});
							} else {
<span class="nc" id="L357">								setRect(btnContinue.right()+2, btnContinue.top(), 20, 21);</span>
<span class="nc" id="L358">								align(this);</span>
<span class="nc" id="L359">								icon.visible = true;</span>
<span class="nc" id="L360">								parent.add(new Tweener(parent, 0.5f) {</span>
									@Override
									protected void updateValues(float progress) {
<span class="nc" id="L363">										float uiAlpha = progress;</span>
<span class="nc" id="L364">										btnContinue.alpha(uiAlpha);</span>
<span class="nc" id="L365">										storyBG.alpha(uiAlpha*0.8f);</span>
<span class="nc" id="L366">										storyMessage.alpha(uiAlpha);</span>
<span class="nc" id="L367">										icon.alpha(uiAlpha);</span>
<span class="nc" id="L368">										loadingText.alpha(uiAlpha);</span>
<span class="nc" id="L369">										im.am = uiAlpha;</span>
<span class="nc" id="L370">									}</span>
								});
							}
<span class="nc" id="L373">						}</span>

						@Override
						protected void onPointerDown() {
<span class="nc bnc" id="L377" title="All 2 branches missed.">							if (icon.visible) {</span>
<span class="nc" id="L378">								super.onPointerDown();</span>
							}
<span class="nc" id="L380">						}</span>
					};
<span class="nc" id="L382">					btnHideStory.icon().originToCenter();</span>
<span class="nc" id="L383">					btnHideStory.icon().angle = 180f;</span>
<span class="nc" id="L384">					btnHideStory.setRect(btnContinue.right()+2, btnContinue.top(), 20, 21);</span>
<span class="nc" id="L385">					align(btnHideStory);</span>
<span class="nc" id="L386">					btnHideStory.enable(false);</span>
<span class="nc" id="L387">					add(btnHideStory);</span>

<span class="nc" id="L389">					btnContinue.alpha(0);</span>
<span class="nc" id="L390">					storyBG.alpha(0);</span>
<span class="nc" id="L391">					storyMessage.alpha(0);</span>
<span class="nc" id="L392">					btnHideStory.icon().alpha(0);</span>
			}
		}

<span class="nc" id="L396">		phase = Phase.FADE_IN;</span>
<span class="nc" id="L397">		timeLeft = fadeTime;</span>
		
<span class="nc bnc" id="L399" title="All 2 branches missed.">		if (thread == null) {</span>
<span class="nc" id="L400">			thread = new Thread() {</span>
				@Override
				public void run() {
					
					try {

<span class="nc" id="L406">						Actor.fixTime();</span>

<span class="nc bnc" id="L408" title="All 8 branches missed.">						switch (mode) {</span>
							case DESCEND:
<span class="nc" id="L410">								descend();</span>
<span class="nc" id="L411">								break;</span>
							case ASCEND:
<span class="nc" id="L413">								ascend();</span>
<span class="nc" id="L414">								break;</span>
							case CONTINUE:
<span class="nc" id="L416">								restore();</span>
<span class="nc" id="L417">								break;</span>
							case RESURRECT:
<span class="nc" id="L419">								resurrect();</span>
<span class="nc" id="L420">								break;</span>
							case RETURN:
<span class="nc" id="L422">								returnTo();</span>
<span class="nc" id="L423">								break;</span>
							case FALL:
<span class="nc" id="L425">								fall();</span>
<span class="nc" id="L426">								break;</span>
							case RESET:
<span class="nc" id="L428">								reset();</span>
								break;
						}
						
<span class="nc" id="L432">					} catch (Exception e) {</span>
						
<span class="nc" id="L434">						error = e;</span>
						
<span class="nc" id="L436">					}</span>

<span class="nc" id="L438">					synchronized (thread) {</span>
<span class="nc bnc" id="L439" title="All 4 branches missed.">						if (phase == Phase.STATIC &amp;&amp; error == null) {</span>
<span class="nc" id="L440">							afterLoading();</span>
						}
<span class="nc" id="L442">					}</span>
<span class="nc" id="L443">				}</span>
			};
<span class="nc" id="L445">			thread.start();</span>
		}
<span class="nc" id="L447">		waitingTime = 0f;</span>
<span class="nc" id="L448">	}</span>

<span class="nc" id="L450">	private int dots = 0;</span>
<span class="nc" id="L451">	private boolean textFadingIn = true;</span>

	@Override
	public void update() {
<span class="nc" id="L455">		super.update();</span>

<span class="nc bnc" id="L457" title="All 4 branches missed.">		if (btnContinue == null || !btnContinue.isActive()) {</span>
<span class="nc" id="L458">			waitingTime += Game.elapsed;</span>
		}

<span class="nc bnc" id="L461" title="All 4 branches missed.">		if (mode != Mode.FALL &amp;&amp; dots != Math.ceil(waitingTime / ((2*fadeTime)/3f))) {</span>
<span class="nc" id="L462">			String text = Messages.get(Mode.class, mode.name());</span>
<span class="nc" id="L463">			dots = (int)Math.ceil(waitingTime / ((2*fadeTime)/3f))%3;</span>
<span class="nc bnc" id="L464" title="All 3 branches missed.">			switch (dots){</span>
				case 1: default:
<span class="nc" id="L466">					loadingText.text(text + &quot;.&quot;);</span>
<span class="nc" id="L467">					break;</span>
				case 2:
<span class="nc" id="L469">					loadingText.text(text + &quot;..&quot;);</span>
<span class="nc" id="L470">					break;</span>
				case 0:
<span class="nc" id="L472">					loadingText.text(text + &quot;...&quot;);</span>
					break;
			}
		}
		
<span class="nc bnc" id="L477" title="All 4 branches missed.">		switch (phase) {</span>
		
		case FADE_IN:
<span class="nc" id="L480">			loadingText.alpha( Math.max(0, fadeTime - (timeLeft-0.333f)));</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">			if ((timeLeft -= Game.elapsed) &lt;= 0) {</span>
<span class="nc" id="L482">				synchronized (thread) {</span>
<span class="nc bnc" id="L483" title="All 4 branches missed.">					if (!thread.isAlive() &amp;&amp; error == null) {</span>
<span class="nc" id="L484">						afterLoading();</span>
					} else {
<span class="nc" id="L486">						phase = Phase.STATIC;</span>
					}
<span class="nc" id="L488">				}</span>
			}
			break;
			
		case FADE_OUT:
<span class="nc" id="L493">			background.acc.set(0);</span>
<span class="nc" id="L494">			background.speed.set(0);</span>

<span class="nc" id="L496">			loadingText.alpha( Math.min(1, timeLeft+0.333f) );</span>

<span class="nc bnc" id="L498" title="All 2 branches missed.">			if (btnContinue != null){</span>
<span class="nc" id="L499">				btnContinue.alpha((timeLeft/fadeTime));</span>
<span class="nc" id="L500">				storyMessage.alpha(btnContinue.alpha());</span>
<span class="nc" id="L501">				storyBG.alpha(btnContinue.alpha()*0.8f);</span>
<span class="nc" id="L502">				btnHideStory.icon().alpha(btnContinue.alpha());</span>
			}
			
<span class="nc bnc" id="L505" title="All 2 branches missed.">			if ((timeLeft -= Game.elapsed) &lt;= 0) {</span>
<span class="nc" id="L506">				Game.switchScene( GameScene.class );</span>
<span class="nc" id="L507">				KeyEvent.clearListeners(); //removes potential listener for continue</span>
<span class="nc" id="L508">				thread = null;</span>
<span class="nc" id="L509">				error = null;</span>
			}
			break;
			
		case STATIC:

<span class="nc bnc" id="L515" title="All 4 branches missed.">			if (btnContinue != null &amp;&amp; textFadingIn) {</span>
<span class="nc" id="L516">				btnContinue.alpha(Math.min(1, btnContinue.alpha() + Game.elapsed));</span>
<span class="nc" id="L517">				storyMessage.alpha(btnContinue.alpha());</span>
<span class="nc" id="L518">				storyBG.alpha(btnContinue.alpha()*0.8f);</span>
<span class="nc" id="L519">				btnHideStory.icon().alpha(btnContinue.alpha());</span>

<span class="nc bnc" id="L521" title="All 2 branches missed.">				if (btnContinue.alpha() == 1){</span>
<span class="nc" id="L522">					textFadingIn = false;</span>
<span class="nc" id="L523">					btnHideStory.enable(true);</span>
				}
			}

			//slowly pan the background side to side in portait mode, if story text is displayed
<span class="nc bnc" id="L528" title="All 6 branches missed.">			if (btnContinue != null &amp;&amp; !textFadingIn &amp;&amp; Game.width &lt; Game.height){</span>
<span class="nc bnc" id="L529" title="All 4 branches missed.">				if (background.speed.isZero() &amp;&amp; background.acc.isZero()){</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">					background.acc.x = background.center().x &gt;= Camera.main.width ? -1f : 1f;</span>
				} else {
<span class="nc" id="L532">					background.speed.x = GameMath.gate(-10, background.speed.x, 10);</span>
<span class="nc bnc" id="L533" title="All 4 branches missed.">					if (background.acc.x &gt; 0 &amp;&amp; background.x &gt;= -25){</span>
<span class="nc" id="L534">						background.acc.x = -2.5f;</span>
<span class="nc bnc" id="L535" title="All 4 branches missed.">					} else if (background.acc.x &lt; 0 &amp;&amp; background.x + background.width() &lt;= Camera.main.width+25){</span>
<span class="nc" id="L536">						background.acc.x = 2.5f;</span>
					}
				}

			}

<span class="nc bnc" id="L542" title="All 2 branches missed.">			if (error != null) {</span>
				String errorMsg;
<span class="nc bnc" id="L544" title="All 2 branches missed.">				if (error instanceof FileNotFoundException)     errorMsg = Messages.get(this, &quot;file_not_found&quot;);</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">				else if (error instanceof IOException)          errorMsg = Messages.get(this, &quot;io_error&quot;);</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">				else if (error.getMessage() != null &amp;&amp;</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">						error.getMessage().equals(&quot;old save&quot;)) errorMsg = Messages.get(this, &quot;io_error&quot;);</span>

<span class="nc" id="L549">				else throw new RuntimeException(&quot;fatal error occurred while moving between floors. &quot; +</span>
							&quot;Seed:&quot; + Dungeon.seed + &quot; depth:&quot; + Dungeon.depth, error);

<span class="nc" id="L552">				add( new WndError( errorMsg ) {</span>
					public void onBackPressed() {
<span class="nc" id="L554">						super.onBackPressed();</span>
<span class="nc" id="L555">						Game.switchScene( StartScene.class );</span>
<span class="nc" id="L556">					}</span>
				} );
<span class="nc" id="L558">				thread = null;</span>
<span class="nc" id="L559">				error = null;</span>
<span class="nc bnc" id="L560" title="All 4 branches missed.">			} else if (thread != null &amp;&amp; (int)waitingTime == 10){</span>
<span class="nc" id="L561">				waitingTime = 11f;</span>
<span class="nc" id="L562">				String s = &quot;&quot;;</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">				for (StackTraceElement t : thread.getStackTrace()){</span>
<span class="nc" id="L564">					s += &quot;\n&quot;;</span>
<span class="nc" id="L565">					s += t.toString();</span>
				}
				//we care about reporting game logic exceptions, not slow IO
<span class="nc bnc" id="L568" title="All 2 branches missed.">				if (!s.contains(&quot;FileUtils.bundleToFile&quot;)){</span>
<span class="nc" id="L569">					ShatteredPixelDungeon.reportException(</span>
							new RuntimeException(&quot;waited more than 10 seconds on levelgen. &quot; +
									&quot;Seed:&quot; + Dungeon.seed + &quot; depth:&quot; + Dungeon.depth + &quot; trace:&quot; +
									s));
				}
			}
			break;
		}

<span class="nc bnc" id="L578" title="All 2 branches missed.">		if (mode == Mode.FALL) {</span>
<span class="nc" id="L579">			loadingText.setPos(</span>
					//the randomization is effectively -2 to +2
					// we don't use the generator stack as levelgen may be occurring
					// and we don't want to accidentally use a seeded generator
<span class="nc" id="L583">					(Camera.main.width - loadingText.width() - 4) + 4*(Random.Float(false)-0.5f),</span>
<span class="nc" id="L584">					(Camera.main.height - loadingText.height() - 6) + 4*(Random.Float(false)-0.5f)</span>
			);
<span class="nc" id="L586">			align(loadingText);</span>
		}
<span class="nc" id="L588">	}</span>

	private void afterLoading(){
<span class="nc bnc" id="L591" title="All 2 branches missed.">		if (btnContinue != null){</span>
<span class="nc" id="L592">			btnContinue.visible = true;</span>
<span class="nc" id="L593">			float alpha = btnContinue.alpha();</span>
<span class="nc" id="L594">			btnContinue.enable(true);</span>
<span class="nc" id="L595">			btnContinue.alpha(alpha);</span>
<span class="nc" id="L596">			phase = Phase.STATIC;</span>
<span class="nc" id="L597">		} else {</span>
<span class="nc" id="L598">			phase = Phase.FADE_OUT;</span>
<span class="nc" id="L599">			timeLeft = fadeTime;</span>
		}

<span class="nc" id="L602">	}</span>

	private void descend() throws IOException {

<span class="nc bnc" id="L606" title="All 2 branches missed.">		if (Dungeon.hero == null) {</span>
<span class="nc" id="L607">			Mob.clearHeldAllies();</span>
<span class="nc" id="L608">			Dungeon.init();</span>
<span class="nc" id="L609">			GameLog.wipe();</span>

			//When debugging, we may start a game at a later depth to quickly test something
			// if this happens, the games quickly generates all prior levels on branch 0 first,
			// which ensures levelgen consistency with a regular game that was played to that depth.
<span class="nc bnc" id="L614" title="All 2 branches missed.">			if (DeviceCompat.isDebug()){</span>
<span class="nc" id="L615">				int trueDepth = Dungeon.depth;</span>
<span class="nc" id="L616">				int trueBranch = Dungeon.branch;</span>
<span class="nc bnc" id="L617" title="All 4 branches missed.">				for (int i = 1; i &lt; trueDepth + (trueBranch == 0 ? 0 : 1); i++){</span>
<span class="nc bnc" id="L618" title="All 2 branches missed.">					if (!Dungeon.levelHasBeenGenerated(i, 0)){</span>
<span class="nc" id="L619">						Dungeon.depth = i;</span>
<span class="nc" id="L620">						Dungeon.branch = 0;</span>
<span class="nc" id="L621">						Dungeon.level = Dungeon.newLevel();</span>
<span class="nc" id="L622">						Dungeon.saveLevel(GamesInProgress.curSlot);</span>
					}
				}
<span class="nc" id="L625">				Dungeon.depth = trueDepth;</span>
<span class="nc" id="L626">				Dungeon.branch = trueBranch;</span>
			}

<span class="nc" id="L629">			Level level = Dungeon.newLevel();</span>
<span class="nc" id="L630">			Dungeon.switchLevel( level, -1 );</span>
<span class="nc" id="L631">		} else {</span>
<span class="nc" id="L632">			Mob.holdAllies( Dungeon.level );</span>
<span class="nc" id="L633">			Dungeon.saveAll();</span>

			Level level;
<span class="nc" id="L636">			Dungeon.depth = curTransition.destDepth;</span>
<span class="nc" id="L637">			Dungeon.branch = curTransition.destBranch;</span>

<span class="nc bnc" id="L639" title="All 2 branches missed.">			if (Dungeon.levelHasBeenGenerated(Dungeon.depth, Dungeon.branch)) {</span>
<span class="nc" id="L640">				level = Dungeon.loadLevel( GamesInProgress.curSlot );</span>
			} else {
<span class="nc" id="L642">				level = Dungeon.newLevel();</span>
			}

<span class="nc" id="L645">			LevelTransition destTransition = level.getTransition(curTransition.destType);</span>
<span class="nc" id="L646">			curTransition = null;</span>
<span class="nc" id="L647">			Dungeon.switchLevel( level, destTransition.cell() );</span>
		}

<span class="nc" id="L650">	}</span>

	//TODO atm falling always just increments depth by 1, do we eventually want to roll it into the transition system?
	private void fall() throws IOException {
		
<span class="nc" id="L655">		Mob.holdAllies( Dungeon.level );</span>
		
<span class="nc" id="L657">		Buff.affect( Dungeon.hero, Chasm.Falling.class );</span>
<span class="nc" id="L658">		Dungeon.saveAll();</span>

		Level level;
<span class="nc" id="L661">		Dungeon.depth++;</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">		if (Dungeon.levelHasBeenGenerated(Dungeon.depth, Dungeon.branch)) {</span>
<span class="nc" id="L663">			level = Dungeon.loadLevel( GamesInProgress.curSlot );</span>
		} else {
<span class="nc" id="L665">			level = Dungeon.newLevel();</span>
		}
<span class="nc" id="L667">		Dungeon.switchLevel( level, level.fallCell( fallIntoPit ));</span>
<span class="nc" id="L668">	}</span>

	private void ascend() throws IOException {
<span class="nc" id="L671">		Mob.holdAllies( Dungeon.level );</span>
<span class="nc" id="L672">		Dungeon.saveAll();</span>

		Level level;
<span class="nc" id="L675">		Dungeon.depth = curTransition.destDepth;</span>
<span class="nc" id="L676">		Dungeon.branch = curTransition.destBranch;</span>

<span class="nc bnc" id="L678" title="All 2 branches missed.">		if (Dungeon.levelHasBeenGenerated(Dungeon.depth, Dungeon.branch)) {</span>
<span class="nc" id="L679">			level = Dungeon.loadLevel( GamesInProgress.curSlot );</span>
		} else {
<span class="nc" id="L681">			level = Dungeon.newLevel();</span>
		}

<span class="nc" id="L684">		LevelTransition destTransition = level.getTransition(curTransition.destType);</span>
<span class="nc" id="L685">		curTransition = null;</span>
<span class="nc" id="L686">		Dungeon.switchLevel( level, destTransition.cell() );</span>
<span class="nc" id="L687">	}</span>
	
	private void returnTo() throws IOException {
<span class="nc" id="L690">		Mob.holdAllies( Dungeon.level );</span>
<span class="nc" id="L691">		Dungeon.saveAll();</span>

		Level level;
<span class="nc" id="L694">		Dungeon.depth = returnDepth;</span>
<span class="nc" id="L695">		Dungeon.branch = returnBranch;</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">		if (Dungeon.levelHasBeenGenerated(Dungeon.depth, Dungeon.branch)) {</span>
<span class="nc" id="L697">			level = Dungeon.loadLevel( GamesInProgress.curSlot );</span>
		} else {
<span class="nc" id="L699">			level = Dungeon.newLevel();</span>
		}

<span class="nc" id="L702">		Dungeon.switchLevel( level, returnPos );</span>
<span class="nc" id="L703">	}</span>
	
	private void restore() throws IOException {
		
<span class="nc" id="L707">		Mob.clearHeldAllies();</span>

<span class="nc" id="L709">		GameLog.wipe();</span>

<span class="nc" id="L711">		Dungeon.loadGame( GamesInProgress.curSlot );</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">		if (Dungeon.depth == -1) {</span>
<span class="nc" id="L713">			Dungeon.depth = Statistics.deepestFloor;</span>
<span class="nc" id="L714">			Dungeon.switchLevel( Dungeon.loadLevel( GamesInProgress.curSlot ), -1 );</span>
		} else {
<span class="nc" id="L716">			Level level = Dungeon.loadLevel( GamesInProgress.curSlot );</span>
<span class="nc" id="L717">			Dungeon.switchLevel( level, Dungeon.hero.pos );</span>
		}
<span class="nc" id="L719">	}</span>
	
	private void resurrect() {
		
<span class="nc" id="L723">		Mob.holdAllies( Dungeon.level );</span>

		Level level;
<span class="nc bnc" id="L726" title="All 2 branches missed.">		if (Dungeon.level.locked) {</span>
<span class="nc" id="L727">			ArrayList&lt;Item&gt; preservedItems = Dungeon.level.getItemsToPreserveFromSealedResurrect();</span>

<span class="nc" id="L729">			Dungeon.hero.resurrect();</span>
<span class="nc" id="L730">			level = Dungeon.newLevel();</span>
<span class="nc" id="L731">			Dungeon.hero.pos = level.randomRespawnCell(Dungeon.hero);</span>
<span class="nc bnc" id="L732" title="All 2 branches missed.">			if (Dungeon.hero.pos == -1) Dungeon.hero.pos = level.entrance();</span>

<span class="nc bnc" id="L734" title="All 2 branches missed.">			for (Item i : preservedItems){</span>
<span class="nc" id="L735">				int pos = level.randomRespawnCell(null);</span>
<span class="nc bnc" id="L736" title="All 2 branches missed.">				if (pos == -1) pos = level.entrance();</span>
<span class="nc" id="L737">				level.drop(i, pos);</span>
<span class="nc" id="L738">			}</span>
<span class="nc" id="L739">			int pos = level.randomRespawnCell(null);</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">			if (pos == -1) pos = level.entrance();</span>
<span class="nc" id="L741">			level.drop(new LostBackpack(), pos);</span>

<span class="nc" id="L743">		} else {</span>
<span class="nc" id="L744">			level = Dungeon.level;</span>
<span class="nc" id="L745">			BArray.setFalse(level.heroFOV);</span>
<span class="nc" id="L746">			BArray.setFalse(level.visited);</span>
<span class="nc" id="L747">			BArray.setFalse(level.mapped);</span>
<span class="nc" id="L748">			int invPos = Dungeon.hero.pos;</span>
<span class="nc" id="L749">			int tries = 0;</span>
			do {
<span class="nc" id="L751">				Dungeon.hero.pos = level.randomRespawnCell(Dungeon.hero);</span>
<span class="nc" id="L752">				tries++;</span>

			//prevents spawning on traps or plants, prefers farther locations first
<span class="nc bnc" id="L755" title="All 2 branches missed.">			} while (level.traps.get(Dungeon.hero.pos) != null</span>
<span class="nc bnc" id="L756" title="All 4 branches missed.">					|| (level.plants.get(Dungeon.hero.pos) != null &amp;&amp; tries &lt; 500)</span>
<span class="nc bnc" id="L757" title="All 2 branches missed.">					|| level.trueDistance(invPos, Dungeon.hero.pos) &lt;= 30 - (tries/10));</span>

			//directly trample grass
<span class="nc bnc" id="L760" title="All 4 branches missed.">			if (level.map[Dungeon.hero.pos] == Terrain.HIGH_GRASS || level.map[Dungeon.hero.pos] == Terrain.FURROWED_GRASS){</span>
<span class="nc" id="L761">				level.map[Dungeon.hero.pos] = Terrain.GRASS;</span>
			}
<span class="nc" id="L763">			Dungeon.hero.resurrect();</span>
<span class="nc" id="L764">			level.drop(new LostBackpack(), invPos);</span>
		}

<span class="nc" id="L767">		Dungeon.switchLevel( level, Dungeon.hero.pos );</span>
<span class="nc" id="L768">	}</span>

	private void reset() throws IOException {
		
<span class="nc" id="L772">		Mob.holdAllies( Dungeon.level );</span>

<span class="nc" id="L774">		SpecialRoom.resetPitRoom(Dungeon.depth+1);</span>

<span class="nc" id="L776">		Level level = Dungeon.newLevel();</span>
<span class="nc" id="L777">		Dungeon.switchLevel( level, level.entrance() );</span>
<span class="nc" id="L778">	}</span>
	
	@Override
	protected void onBackPressed() {
		//Do nothing
<span class="nc" id="L783">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>