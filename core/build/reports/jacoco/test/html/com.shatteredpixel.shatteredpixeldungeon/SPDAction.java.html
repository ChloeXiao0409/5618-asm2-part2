<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SPDAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">core</a> &gt; <a href="index.source.html" class="el_package">com.shatteredpixel.shatteredpixeldungeon</a> &gt; <span class="el_source">SPDAction.java</span></div><h1>SPDAction.java</h1><pre class="source lang-java linenums">/*
 * Pixel Dungeon
 * Copyright (C) 2012-2015 Oleg Dolya
 *
 * Shattered Pixel Dungeon
 * Copyright (C) 2014-2024 Evan Debenham
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;
 */

package com.shatteredpixel.shatteredpixeldungeon;

import com.badlogic.gdx.Input;
import com.watabou.input.ControllerHandler;
import com.watabou.input.GameAction;
import com.watabou.input.KeyBindings;
import com.watabou.input.KeyEvent;
import com.watabou.utils.Bundle;
import com.watabou.utils.FileUtils;

import java.io.IOException;
import java.util.LinkedHashMap;

public class SPDAction extends GameAction {

	protected SPDAction( String name ){
<span class="nc" id="L38">		super( name );</span>
<span class="nc" id="L39">	}</span>

	//--New references to existing actions from GameAction
<span class="nc" id="L42">	public static final GameAction NONE  = GameAction.NONE;</span>
<span class="nc" id="L43">	public static final GameAction BACK  = GameAction.BACK;</span>

<span class="nc" id="L45">	public static final GameAction LEFT_CLICK   = GameAction.LEFT_CLICK;</span>
<span class="nc" id="L46">	public static final GameAction RIGHT_CLICK  = GameAction.RIGHT_CLICK;</span>
<span class="nc" id="L47">	public static final GameAction MIDDLE_CLICK = GameAction.MIDDLE_CLICK;</span>
	//--

<span class="nc" id="L50">	public static final GameAction N            = new SPDAction(&quot;n&quot;);</span>
<span class="nc" id="L51">	public static final GameAction W            = new SPDAction(&quot;w&quot;);</span>
<span class="nc" id="L52">	public static final GameAction S            = new SPDAction(&quot;s&quot;);</span>
<span class="nc" id="L53">	public static final GameAction E            = new SPDAction(&quot;e&quot;);</span>
<span class="nc" id="L54">	public static final GameAction NW           = new SPDAction(&quot;nw&quot;);</span>
<span class="nc" id="L55">	public static final GameAction NE           = new SPDAction(&quot;ne&quot;);</span>
<span class="nc" id="L56">	public static final GameAction SW           = new SPDAction(&quot;sw&quot;);</span>
<span class="nc" id="L57">	public static final GameAction SE           = new SPDAction(&quot;se&quot;);</span>
<span class="nc" id="L58">	public static final GameAction WAIT_OR_PICKUP   = new SPDAction(&quot;wait_or_pickup&quot;);</span>

<span class="nc" id="L60">	public static final GameAction INVENTORY    = new SPDAction(&quot;inventory&quot;);</span>
<span class="nc" id="L61">	public static final GameAction INVENTORY_SELECTOR   = new SPDAction(&quot;inventory_selector&quot;);</span>
<span class="nc" id="L62">	public static final GameAction QUICKSLOT_SELECTOR   = new SPDAction(&quot;quickslot_selector&quot;);</span>
<span class="nc" id="L63">	public static final GameAction QUICKSLOT_1  = new SPDAction(&quot;quickslot_1&quot;);</span>
<span class="nc" id="L64">	public static final GameAction QUICKSLOT_2  = new SPDAction(&quot;quickslot_2&quot;);</span>
<span class="nc" id="L65">	public static final GameAction QUICKSLOT_3  = new SPDAction(&quot;quickslot_3&quot;);</span>
<span class="nc" id="L66">	public static final GameAction QUICKSLOT_4  = new SPDAction(&quot;quickslot_4&quot;);</span>
<span class="nc" id="L67">	public static final GameAction QUICKSLOT_5  = new SPDAction(&quot;quickslot_5&quot;);</span>
<span class="nc" id="L68">	public static final GameAction QUICKSLOT_6  = new SPDAction(&quot;quickslot_6&quot;);</span>

<span class="nc" id="L70">	public static final GameAction BAG_1        = new SPDAction(&quot;bag_1&quot;);</span>
<span class="nc" id="L71">	public static final GameAction BAG_2        = new SPDAction(&quot;bag_2&quot;);</span>
<span class="nc" id="L72">	public static final GameAction BAG_3        = new SPDAction(&quot;bag_3&quot;);</span>
<span class="nc" id="L73">	public static final GameAction BAG_4        = new SPDAction(&quot;bag_4&quot;);</span>
<span class="nc" id="L74">	public static final GameAction BAG_5        = new SPDAction(&quot;bag_5&quot;);</span>

<span class="nc" id="L76">	public static final GameAction EXAMINE      = new SPDAction(&quot;examine&quot;);</span>
<span class="nc" id="L77">	public static final GameAction WAIT         = new SPDAction(&quot;wait&quot;);</span>
<span class="nc" id="L78">	public static final GameAction REST         = new SPDAction(&quot;rest&quot;);</span>

<span class="nc" id="L80">	public static final GameAction TAG_ATTACK   = new SPDAction(&quot;tag_attack&quot;);</span>
<span class="nc" id="L81">	public static final GameAction TAG_ACTION   = new SPDAction(&quot;tag_action&quot;);</span>
<span class="nc" id="L82">	public static final GameAction TAG_LOOT     = new SPDAction(&quot;tag_loot&quot;);</span>
<span class="nc" id="L83">	public static final GameAction TAG_RESUME   = new SPDAction(&quot;tag_resume&quot;);</span>

<span class="nc" id="L85">	public static final GameAction CYCLE        = new SPDAction(&quot;cycle&quot;);</span>

<span class="nc" id="L87">	public static final GameAction HERO_INFO    = new SPDAction(&quot;hero_info&quot;);</span>
<span class="nc" id="L88">	public static final GameAction JOURNAL      = new SPDAction(&quot;journal&quot;);</span>

<span class="nc" id="L90">	public static final GameAction ZOOM_IN      = new SPDAction(&quot;zoom_in&quot;);</span>
<span class="nc" id="L91">	public static final GameAction ZOOM_OUT     = new SPDAction(&quot;zoom_out&quot;);</span>

<span class="nc" id="L93">	private static final LinkedHashMap&lt;Integer, GameAction&gt; defaultBindings = new LinkedHashMap&lt;&gt;();</span>
	static {
<span class="nc" id="L95">		defaultBindings.put( Input.Keys.ESCAPE,         SPDAction.BACK );</span>
<span class="nc" id="L96">		defaultBindings.put( Input.Keys.BACKSPACE,      SPDAction.BACK );</span>

<span class="nc" id="L98">		defaultBindings.put( Input.Keys.W,              SPDAction.N );</span>
<span class="nc" id="L99">		defaultBindings.put( Input.Keys.A,              SPDAction.W );</span>
<span class="nc" id="L100">		defaultBindings.put( Input.Keys.S,              SPDAction.S );</span>
<span class="nc" id="L101">		defaultBindings.put( Input.Keys.D,              SPDAction.E );</span>
<span class="nc" id="L102">		defaultBindings.put( Input.Keys.SPACE,          SPDAction.WAIT_OR_PICKUP);</span>

<span class="nc" id="L104">		defaultBindings.put( Input.Keys.UP,             SPDAction.N );</span>
<span class="nc" id="L105">		defaultBindings.put( Input.Keys.LEFT,           SPDAction.W );</span>
<span class="nc" id="L106">		defaultBindings.put( Input.Keys.DOWN,           SPDAction.S );</span>
<span class="nc" id="L107">		defaultBindings.put( Input.Keys.RIGHT,          SPDAction.E );</span>

<span class="nc" id="L109">		defaultBindings.put( Input.Keys.NUMPAD_8,       SPDAction.N );</span>
<span class="nc" id="L110">		defaultBindings.put( Input.Keys.NUMPAD_4,       SPDAction.W );</span>
<span class="nc" id="L111">		defaultBindings.put( Input.Keys.NUMPAD_2,       SPDAction.S );</span>
<span class="nc" id="L112">		defaultBindings.put( Input.Keys.NUMPAD_6,       SPDAction.E );</span>
<span class="nc" id="L113">		defaultBindings.put( Input.Keys.NUMPAD_7,       SPDAction.NW );</span>
<span class="nc" id="L114">		defaultBindings.put( Input.Keys.NUMPAD_9,       SPDAction.NE );</span>
<span class="nc" id="L115">		defaultBindings.put( Input.Keys.NUMPAD_1,       SPDAction.SW );</span>
<span class="nc" id="L116">		defaultBindings.put( Input.Keys.NUMPAD_3,       SPDAction.SE );</span>
<span class="nc" id="L117">		defaultBindings.put( Input.Keys.NUMPAD_5,       SPDAction.WAIT_OR_PICKUP );</span>

<span class="nc" id="L119">		defaultBindings.put( Input.Keys.F,              SPDAction.INVENTORY );</span>
<span class="nc" id="L120">		defaultBindings.put( Input.Keys.I,              SPDAction.INVENTORY );</span>
<span class="nc" id="L121">		defaultBindings.put( Input.Keys.NUM_1,          SPDAction.QUICKSLOT_1 );</span>
<span class="nc" id="L122">		defaultBindings.put( Input.Keys.NUM_2,          SPDAction.QUICKSLOT_2 );</span>
<span class="nc" id="L123">		defaultBindings.put( Input.Keys.NUM_3,          SPDAction.QUICKSLOT_3 );</span>
<span class="nc" id="L124">		defaultBindings.put( Input.Keys.NUM_4,          SPDAction.QUICKSLOT_4 );</span>
<span class="nc" id="L125">		defaultBindings.put( Input.Keys.NUM_5,          SPDAction.QUICKSLOT_5 );</span>
<span class="nc" id="L126">		defaultBindings.put( Input.Keys.NUM_6,          SPDAction.QUICKSLOT_6 );</span>

<span class="nc" id="L128">		defaultBindings.put( Input.Keys.F1,             SPDAction.BAG_1 );</span>
<span class="nc" id="L129">		defaultBindings.put( Input.Keys.F2,             SPDAction.BAG_2 );</span>
<span class="nc" id="L130">		defaultBindings.put( Input.Keys.F3,             SPDAction.BAG_3 );</span>
<span class="nc" id="L131">		defaultBindings.put( Input.Keys.F4,             SPDAction.BAG_4 );</span>
<span class="nc" id="L132">		defaultBindings.put( Input.Keys.F5,             SPDAction.BAG_5 );</span>

<span class="nc" id="L134">		defaultBindings.put( Input.Keys.E,              SPDAction.EXAMINE );</span>
<span class="nc" id="L135">		defaultBindings.put( Input.Keys.Z,              SPDAction.REST );</span>

<span class="nc" id="L137">		defaultBindings.put( Input.Keys.Q,              SPDAction.TAG_ATTACK );</span>
<span class="nc" id="L138">		defaultBindings.put( Input.Keys.TAB,            SPDAction.CYCLE);</span>
<span class="nc" id="L139">		defaultBindings.put( Input.Keys.X,              SPDAction.TAG_ACTION );</span>
<span class="nc" id="L140">		defaultBindings.put( Input.Keys.C,              SPDAction.TAG_LOOT );</span>
<span class="nc" id="L141">		defaultBindings.put( Input.Keys.ENTER,          SPDAction.TAG_LOOT );</span>
<span class="nc" id="L142">		defaultBindings.put( Input.Keys.R,              SPDAction.TAG_RESUME );</span>

<span class="nc" id="L144">		defaultBindings.put( Input.Keys.H,              SPDAction.HERO_INFO );</span>
<span class="nc" id="L145">		defaultBindings.put( Input.Keys.J,              SPDAction.JOURNAL );</span>

<span class="nc" id="L147">		defaultBindings.put( Input.Keys.PLUS,           SPDAction.ZOOM_IN );</span>
<span class="nc" id="L148">		defaultBindings.put( Input.Keys.EQUALS,         SPDAction.ZOOM_IN );</span>
<span class="nc" id="L149">		defaultBindings.put( Input.Keys.MINUS,          SPDAction.ZOOM_OUT );</span>
	}

	public static LinkedHashMap&lt;Integer, GameAction&gt; getDefaults() {
<span class="nc" id="L153">		return new LinkedHashMap&lt;&gt;(defaultBindings);</span>
	}

<span class="nc" id="L156">	private static final LinkedHashMap&lt;Integer, GameAction&gt; defaultControllerBindings = new LinkedHashMap&lt;&gt;();</span>
	static {
<span class="nc" id="L158">		defaultControllerBindings.put( Input.Keys.BUTTON_START,     SPDAction.BACK );</span>
<span class="nc" id="L159">		defaultControllerBindings.put( Input.Keys.BUTTON_SELECT,    SPDAction.JOURNAL );</span>

<span class="nc" id="L161">		defaultControllerBindings.put( Input.Keys.BUTTON_R2,        SPDAction.LEFT_CLICK );</span>
<span class="nc" id="L162">		defaultControllerBindings.put( Input.Keys.BUTTON_THUMBR,    SPDAction.LEFT_CLICK );</span>
<span class="nc" id="L163">		defaultControllerBindings.put( Input.Keys.BUTTON_L2,        SPDAction.RIGHT_CLICK );</span>

<span class="nc" id="L165">		defaultControllerBindings.put( Input.Keys.DPAD_UP+1000,     SPDAction.TAG_ACTION );</span>
<span class="nc" id="L166">		defaultControllerBindings.put( Input.Keys.DPAD_LEFT+1000,   SPDAction.TAG_LOOT );</span>
<span class="nc" id="L167">		defaultControllerBindings.put( Input.Keys.DPAD_DOWN+1000,   SPDAction.TAG_RESUME );</span>
<span class="nc" id="L168">		defaultControllerBindings.put( Input.Keys.DPAD_RIGHT+1000,  SPDAction.CYCLE );</span>

<span class="nc" id="L170">		defaultControllerBindings.put( Input.Keys.BUTTON_THUMBL,    SPDAction.WAIT_OR_PICKUP );</span>

<span class="nc" id="L172">		defaultControllerBindings.put( Input.Keys.BUTTON_R1,        SPDAction.ZOOM_IN );</span>
<span class="nc" id="L173">		defaultControllerBindings.put( Input.Keys.BUTTON_L1,        SPDAction.ZOOM_OUT );</span>

<span class="nc" id="L175">		defaultControllerBindings.put( Input.Keys.BUTTON_A,         SPDAction.TAG_ATTACK );</span>
<span class="nc" id="L176">		defaultControllerBindings.put( Input.Keys.BUTTON_B,         SPDAction.EXAMINE );</span>
<span class="nc" id="L177">		defaultControllerBindings.put( Input.Keys.BUTTON_X,         SPDAction.QUICKSLOT_SELECTOR );</span>
<span class="nc" id="L178">		defaultControllerBindings.put( Input.Keys.BUTTON_Y,         SPDAction.INVENTORY_SELECTOR );</span>
	}

	public static LinkedHashMap&lt;Integer, GameAction&gt; getControllerDefaults() {
<span class="nc" id="L182">		return new LinkedHashMap&lt;&gt;(defaultControllerBindings);</span>
	}

	static {
		//hard bindings for android devices
<span class="nc" id="L187">		KeyBindings.addHardBinding( Input.Keys.BACK, SPDAction.BACK );</span>
<span class="nc" id="L188">		KeyBindings.addHardBinding( Input.Keys.MENU, SPDAction.INVENTORY );</span>

		//hard bindings for desktop fullscreen toggle
		//not bound to specific game actions, see PixelScene
		//Note that user-entered bindings can override these individually, and that's fine.
<span class="nc" id="L193">		KeyBindings.addHardBinding( Input.Keys.ALT_RIGHT, SPDAction.NONE );</span>
<span class="nc" id="L194">		KeyBindings.addHardBinding( Input.Keys.ENTER, SPDAction.NONE );</span>
<span class="nc" id="L195">	}</span>

	//we only save/loads keys which differ from the default configuration.
	private static final String BINDINGS_FILE = &quot;keybinds.dat&quot;;

	public static void loadBindings(){

<span class="nc bnc" id="L202" title="All 2 branches missed.">		if (!KeyBindings.getAllBindings().isEmpty()){</span>
<span class="nc" id="L203">			return;</span>
		}

		try {
<span class="nc" id="L207">			Bundle b = FileUtils.bundleFromFile(BINDINGS_FILE);</span>

<span class="nc" id="L209">			Bundle firstKeys = b.getBundle(&quot;first_keys&quot;);</span>
<span class="nc" id="L210">			Bundle secondKeys = b.getBundle(&quot;second_keys&quot;);</span>
<span class="nc" id="L211">			Bundle thirdKeys = b.getBundle(&quot;third_keys&quot;);</span>

<span class="nc" id="L213">			LinkedHashMap&lt;Integer, GameAction&gt; defaults = getDefaults();</span>
<span class="nc" id="L214">			LinkedHashMap&lt;Integer, GameAction&gt; merged = new LinkedHashMap&lt;&gt;();</span>

<span class="nc bnc" id="L216" title="All 2 branches missed.">			for (GameAction a : allActions()) {</span>
<span class="nc bnc" id="L217" title="All 4 branches missed.">				if (firstKeys.contains(a.name()) &amp;&amp; KeyEvent.isKeyboardKey(firstKeys.getInt(a.name()))) {</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">					if (firstKeys.getInt(a.name()) == 0){</span>
<span class="nc" id="L219">						continue; //we have no keys assigned to this action, move to the next one</span>
					} else {
<span class="nc" id="L221">						merged.put(firstKeys.getInt(a.name()), a);</span>
						//remove whatever the first default key was for this action, if any
<span class="nc bnc" id="L223" title="All 2 branches missed.">						for (int i : defaults.keySet()) {</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">							if (defaults.get(i) == a) {</span>
<span class="nc" id="L225">								defaults.remove(i);</span>
<span class="nc" id="L226">								break;</span>
							}
<span class="nc" id="L228">						}</span>
					}
				} else {
					//if we have no custom key here, find the first one from defaults and merge it
<span class="nc bnc" id="L232" title="All 2 branches missed.">					for (int i : defaults.keySet()){</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">						if (defaults.get(i) == a){</span>
<span class="nc" id="L234">							merged.put(i, defaults.remove(i));</span>
<span class="nc" id="L235">							break;</span>
						}
<span class="nc" id="L237">					}</span>
				}

<span class="nc bnc" id="L240" title="All 4 branches missed.">				if (secondKeys.contains(a.name()) &amp;&amp; KeyEvent.isKeyboardKey(secondKeys.getInt(a.name()))) {</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">					if (secondKeys.getInt(a.name()) == 0){</span>
<span class="nc" id="L242">						continue; //we have no more keys assigned to this action, move to the next one</span>
					} else {
<span class="nc" id="L244">						merged.put(secondKeys.getInt(a.name()), a);</span>
						//remove whatever the second default key was for this action, if any
<span class="nc bnc" id="L246" title="All 2 branches missed.">						for (int i : defaults.keySet()){</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">							if (defaults.get(i) == a){</span>
<span class="nc" id="L248">								defaults.remove(i);</span>
<span class="nc" id="L249">								break;</span>
							}
<span class="nc" id="L251">						}</span>
					}
				} else {
					//if we have no custom key here, find the next one from defaults and merge it
<span class="nc bnc" id="L255" title="All 2 branches missed.">					for (int i : defaults.keySet()){</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">						if (defaults.get(i) == a){</span>
<span class="nc" id="L257">							merged.put(i, defaults.remove(i));</span>
<span class="nc" id="L258">							break;</span>
						}
<span class="nc" id="L260">					}</span>
				}

<span class="nc bnc" id="L263" title="All 4 branches missed.">				if (thirdKeys.contains(a.name()) &amp;&amp; KeyEvent.isKeyboardKey(thirdKeys.getInt(a.name()))) {</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">					if (thirdKeys.getInt(a.name()) == 0){</span>
<span class="nc" id="L265">						continue; //we have no more keys assigned to this action, move to the next one</span>
					} else {
<span class="nc" id="L267">						merged.put(thirdKeys.getInt(a.name()), a);</span>
						//remove whatever the third default key was for this action, if any
<span class="nc bnc" id="L269" title="All 2 branches missed.">						for (int i : defaults.keySet()){</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">							if (defaults.get(i) == a){</span>
<span class="nc" id="L271">								defaults.remove(i);</span>
<span class="nc" id="L272">								break;</span>
							}
<span class="nc" id="L274">						}</span>
					}
				} else {
					//if we have no custom key here, find the next one from defaults and merge it
<span class="nc bnc" id="L278" title="All 2 branches missed.">					for (int i : defaults.keySet()){</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">						if (defaults.get(i) == a){</span>
<span class="nc" id="L280">							merged.put(i, defaults.remove(i));</span>
<span class="nc" id="L281">							break;</span>
						}
<span class="nc" id="L283">					}</span>
				}

<span class="nc" id="L286">			}</span>

<span class="nc" id="L288">			KeyBindings.setAllBindings(merged);</span>

<span class="nc" id="L290">			defaults = getControllerDefaults();</span>
<span class="nc" id="L291">			merged.clear();</span>

<span class="nc" id="L293">			Bundle firstButtons = b.getBundle(&quot;first_keys_controller&quot;);</span>
<span class="nc" id="L294">			Bundle secondButtons = b.getBundle(&quot;second_keys_controller&quot;);</span>
<span class="nc" id="L295">			Bundle thirdButtons = b.getBundle(&quot;third_keys_controller&quot;);</span>

<span class="nc bnc" id="L297" title="All 2 branches missed.">			for (GameAction a : allActions()) {</span>
<span class="nc bnc" id="L298" title="All 4 branches missed.">				if (firstButtons.contains(a.name()) &amp;&amp; ControllerHandler.icControllerKey(firstButtons.getInt(a.name()))) {</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">					if (firstButtons.getInt(a.name()) == 0){</span>
<span class="nc" id="L300">						continue; //we have no keys assigned to this action, move to the next one</span>
					} else {
<span class="nc" id="L302">						merged.put(firstButtons.getInt(a.name()), a);</span>
						//remove whatever the first default button was for this action, if any
<span class="nc bnc" id="L304" title="All 2 branches missed.">						for (int i : defaults.keySet()) {</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">							if (defaults.get(i) == a) {</span>
<span class="nc" id="L306">								defaults.remove(i);</span>
<span class="nc" id="L307">								break;</span>
							}
<span class="nc" id="L309">						}</span>
					}
				} else {
					//if we have no custom key here, find the first one from defaults and merge it
<span class="nc bnc" id="L313" title="All 2 branches missed.">					for (int i : defaults.keySet()){</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">						if (defaults.get(i) == a){</span>
<span class="nc" id="L315">							merged.put(i, defaults.remove(i));</span>
<span class="nc" id="L316">							break;</span>
						}
<span class="nc" id="L318">					}</span>
				}

<span class="nc bnc" id="L321" title="All 4 branches missed.">				if (secondButtons.contains(a.name()) &amp;&amp; ControllerHandler.icControllerKey(secondButtons.getInt(a.name()))) {</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">					if (secondButtons.getInt(a.name()) == 0){</span>
<span class="nc" id="L323">						continue; //we have no more keys assigned to this action, move to the next one</span>
					} else {
<span class="nc" id="L325">						merged.put(secondButtons.getInt(a.name()), a);</span>
						//remove whatever the second default button was for this action, if any
<span class="nc bnc" id="L327" title="All 2 branches missed.">						for (int i : defaults.keySet()) {</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">							if (defaults.get(i) == a) {</span>
<span class="nc" id="L329">								defaults.remove(i);</span>
<span class="nc" id="L330">								break;</span>
							}
<span class="nc" id="L332">						}</span>
					}
				} else {
					//if we have no custom key here, find the next one from defaults and merge it
<span class="nc bnc" id="L336" title="All 2 branches missed.">					for (int i : defaults.keySet()){</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">						if (defaults.get(i) == a){</span>
<span class="nc" id="L338">							merged.put(i, defaults.remove(i));</span>
<span class="nc" id="L339">							break;</span>
						}
<span class="nc" id="L341">					}</span>
				}

<span class="nc bnc" id="L344" title="All 4 branches missed.">				if (thirdButtons.contains(a.name()) &amp;&amp; ControllerHandler.icControllerKey(thirdButtons.getInt(a.name()))) {</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">					if (thirdButtons.getInt(a.name()) == 0){</span>
<span class="nc" id="L346">						continue; //we have no more keys assigned to this action, move to the next one</span>
					} else {
<span class="nc" id="L348">						merged.put(thirdButtons.getInt(a.name()), a);</span>
						//remove whatever the third default button was for this action, if any
<span class="nc bnc" id="L350" title="All 2 branches missed.">						for (int i : defaults.keySet()) {</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">							if (defaults.get(i) == a) {</span>
<span class="nc" id="L352">								defaults.remove(i);</span>
<span class="nc" id="L353">								break;</span>
							}
<span class="nc" id="L355">						}</span>
					}
				} else {
					//if we have no custom key here, find the next one from defaults and merge it
<span class="nc bnc" id="L359" title="All 2 branches missed.">					for (int i : defaults.keySet()){</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">						if (defaults.get(i) == a){</span>
<span class="nc" id="L361">							merged.put(i, defaults.remove(i));</span>
<span class="nc" id="L362">							break;</span>
						}
<span class="nc" id="L364">					}</span>
				}

<span class="nc" id="L367">			}</span>

<span class="nc" id="L369">			KeyBindings.setAllControllerBindings(merged);</span>

<span class="nc" id="L371">		} catch (Exception e){</span>
<span class="nc" id="L372">			KeyBindings.setAllBindings(getDefaults());</span>
<span class="nc" id="L373">			KeyBindings.setAllControllerBindings(getControllerDefaults());</span>
<span class="nc" id="L374">		}</span>

<span class="nc" id="L376">	}</span>

	public static void saveBindings(){

<span class="nc" id="L380">		Bundle b = new Bundle();</span>

<span class="nc" id="L382">		Bundle firstKeys = new Bundle();</span>
<span class="nc" id="L383">		Bundle secondKeys = new Bundle();</span>
<span class="nc" id="L384">		Bundle thirdKeys = new Bundle();</span>

<span class="nc bnc" id="L386" title="All 2 branches missed.">		for (GameAction a : allActions()){</span>
<span class="nc" id="L387">			int firstCur = 0;</span>
<span class="nc" id="L388">			int secondCur = 0;</span>
<span class="nc" id="L389">			int thirdCur = 0;</span>
<span class="nc" id="L390">			int firstDef = 0;</span>
<span class="nc" id="L391">			int secondDef = 0;</span>
<span class="nc" id="L392">			int thirdDef = 0;</span>

<span class="nc bnc" id="L394" title="All 2 branches missed.">			for (int i : defaultBindings.keySet()){</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">				if (defaultBindings.get(i) == a){</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">					if (firstDef == 0) {</span>
<span class="nc" id="L397">						firstDef = i;</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">					} else if (secondDef == 0) {</span>
<span class="nc" id="L399">						secondDef = i;</span>
					} else {
<span class="nc" id="L401">						thirdDef = i;</span>
					}
				}
<span class="nc" id="L404">			}</span>

<span class="nc" id="L406">			LinkedHashMap&lt;Integer, GameAction&gt; curBindings = KeyBindings.getAllBindings();</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">			for (int i : curBindings.keySet()){</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">				if (curBindings.get(i) == a){</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">					if (firstCur == 0) {</span>
<span class="nc" id="L410">						firstCur = i;</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">					} else if (secondCur == 0) {</span>
<span class="nc" id="L412">						secondCur = i;</span>
					} else {
<span class="nc" id="L414">						thirdCur = i;</span>
					}
				}
<span class="nc" id="L417">			}</span>

<span class="nc bnc" id="L419" title="All 2 branches missed.">			if (firstCur != firstDef){</span>
<span class="nc" id="L420">				firstKeys.put(a.name(), firstCur);</span>
			}
<span class="nc bnc" id="L422" title="All 2 branches missed.">			if (secondCur != secondDef){</span>
<span class="nc" id="L423">				secondKeys.put(a.name(), secondCur);</span>
			}
<span class="nc bnc" id="L425" title="All 2 branches missed.">			if (thirdCur != thirdDef){</span>
<span class="nc" id="L426">				thirdKeys.put(a.name(), thirdCur);</span>
			}

<span class="nc" id="L429">		}</span>

<span class="nc" id="L431">		b.put(&quot;first_keys&quot;, firstKeys);</span>
<span class="nc" id="L432">		b.put(&quot;second_keys&quot;, secondKeys);</span>
<span class="nc" id="L433">		b.put(&quot;third_keys&quot;, thirdKeys);</span>

<span class="nc" id="L435">		Bundle firstButtons = new Bundle();</span>
<span class="nc" id="L436">		Bundle secondButtons = new Bundle();</span>
<span class="nc" id="L437">		Bundle thirdButtons = new Bundle();</span>

<span class="nc bnc" id="L439" title="All 2 branches missed.">		for (GameAction a : allActions()){</span>
<span class="nc" id="L440">			int firstCur = 0;</span>
<span class="nc" id="L441">			int secondCur = 0;</span>
<span class="nc" id="L442">			int thirdCur = 0;</span>
<span class="nc" id="L443">			int firstDef = 0;</span>
<span class="nc" id="L444">			int secondDef = 0;</span>
<span class="nc" id="L445">			int thirdDef = 0;</span>

<span class="nc bnc" id="L447" title="All 2 branches missed.">			for (int i : defaultControllerBindings.keySet()){</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">				if (defaultControllerBindings.get(i) == a){</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">					if (firstDef == 0) {</span>
<span class="nc" id="L450">						firstDef = i;</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">					} else if (secondDef == 0) {</span>
<span class="nc" id="L452">						secondDef = i;</span>
					} else {
<span class="nc" id="L454">						thirdDef = i;</span>
					}
				}
<span class="nc" id="L457">			}</span>

<span class="nc" id="L459">			LinkedHashMap&lt;Integer, GameAction&gt; curBindings = KeyBindings.getAllControllerBindings();</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">			for (int i : curBindings.keySet()){</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">				if (curBindings.get(i) == a){</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">					if (firstCur == 0) {</span>
<span class="nc" id="L463">						firstCur = i;</span>
<span class="nc bnc" id="L464" title="All 2 branches missed.">					} else if (secondCur == 0) {</span>
<span class="nc" id="L465">						secondCur = i;</span>
					} else {
<span class="nc" id="L467">						thirdCur = i;</span>
					}
				}
<span class="nc" id="L470">			}</span>

<span class="nc bnc" id="L472" title="All 2 branches missed.">			if (firstCur != firstDef){</span>
<span class="nc" id="L473">				firstButtons.put(a.name(), firstCur);</span>
			}
<span class="nc bnc" id="L475" title="All 2 branches missed.">			if (secondCur != secondDef){</span>
<span class="nc" id="L476">				secondButtons.put(a.name(), secondCur);</span>
			}
<span class="nc bnc" id="L478" title="All 2 branches missed.">			if (thirdCur != thirdDef){</span>
<span class="nc" id="L479">				thirdButtons.put(a.name(), thirdCur);</span>
			}

<span class="nc" id="L482">		}</span>

<span class="nc" id="L484">		b.put(&quot;first_keys_controller&quot;, firstButtons);</span>
<span class="nc" id="L485">		b.put(&quot;second_keys_controller&quot;, secondButtons);</span>
<span class="nc" id="L486">		b.put(&quot;third_keys_controller&quot;, thirdButtons);</span>

		try {
<span class="nc" id="L489">			FileUtils.bundleToFile(BINDINGS_FILE, b);</span>
<span class="nc" id="L490">		} catch (IOException e) {</span>
<span class="nc" id="L491">			ShatteredPixelDungeon.reportException(e);</span>
<span class="nc" id="L492">		}</span>

<span class="nc" id="L494">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>